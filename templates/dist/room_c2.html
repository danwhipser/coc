{% include 'dist/header.html' %}
<!-- Head -->
<style>
    .modal-backdrop{z-index:1019;}
    .text-white h5{color: #ffffff;}
</style>
    <body>
 <!-- Scripts -->
{% include 'dist/jsclude.html' %}
<!-- Scripts -->

        <div class="layout">
            {% include 'dist/navibar.html' %}
            {% include 'dist/sidebar.html' %}

            <!-- Main Content -->
            <div class="main main-visible" data-mobile-height="">

                <!-- Chat -->
                <div id="chat-1" class="chat">

                    <!-- Chat: body -->
                    <div class="chat-body">

                        <!-- Chat: Header -->
                        <div class="chat-header border-bottom py-4 py-lg-6 px-lg-8">
                            <div class="container-xxl">

                                <div class="row align-items-center">

                                    <!-- Close chat(mobile) -->
                                    <div class="col-3 d-xl-none">
                                        <ul class="list-inline mb-0">
                                            <li class="list-inline-item">
                                                <a class="text-muted px-0" href="#" data-chat="open">
                                                    <i class="icon-md fe-chevron-left"></i>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>

                                    <!-- Chat photo -->
                                    <div class="col-6 col-xl-6">
                                        <div class="media text-center text-xl-left">
                                            {% for gd in group_deteil %}
                                                {% if gd.1==74 %}
                                                    {% if gd.2=="0" %}
                                                    <div class="avatar mr-5 bg-primary text-white text-truncate room_name_pt">
                                                        <span class="room_name_p">{{group_name}}</span>
                                                    </div>
                                                    {% else %}
                                                    <div class="avatar avatar-sm d-none d-xl-inline-block mr-5">
                                                        <img src="{{gd.2}}" class="avatar-img" alt="{{group_name}}">
                                                    </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                            <div class="media-body align-self-center text-truncate">
                                                <h6 class="text-truncate mb-n1"><a class="text-dark" href="javascript:;" data-chat-sidebar-toggle="#chat-1-info">{{group_name}}</a></h6>
                                                {% for gd in group_deteil %}
                                                {% if gd.1==69 %}
                                                <small class="text-muted">{{gd.2}}</small>
                                                {% endif %}
                                                {% endfor %}
                                                <small class="text-muted mx-2"> • </small>
                                                {% for gd in group_deteil %}
                                                {% if gd.1==71 %}
                                                <small class="text-muted">{{gd.2}}</small>
                                                {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Chat toolbar -->
                                    <div class="col-3 col-xl-6 text-right">
                                        <ul class="nav justify-content-end">
                                            <li class="nav-item list-inline-item d-none d-xl-block mr-0">
                                                <a class="nav-link text-muted px-3" href="#" data-chat-sidebar-toggle="#chat-1-info" title="房间信息">
                                                    <i class="icon-md fe-more-vertical"></i>
                                                </a>
                                            </li>
                                            <!-- Mobile nav -->
                                            <li class="nav-item list-inline-item d-block d-xl-none">
                                                <a onclick="show_myde();" class="nav-link text-muted px-0" href="#">
                                                        <i class="icon-md fe-more-vertical"></i>
                                                    </a>
                                            </li>
                                            <!-- Mobile nav -->
                                        </ul>
                                    </div>

                                </div><!-- .row -->

                            </div>
                        </div>
                        <!-- Chat: Header -->

                        <!-- Chat: Search -->
                        <div class="collapse border-bottom px-lg-8" id="chat-1-search">
                            <div class="container-xxl py-4 py-lg-6">

                                <div class="input-group">
                                    <input type="text" class="form-control form-control-lg" placeholder="搜索对话" aria-label="搜索对话">

                                    <div class="input-group-append">
                                        <button class="btn btn-lg btn-ico btn-secondary btn-minimal" type="submit">
                                            <i class="fe-search"></i>
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                        <!-- Chat: Search -->

                        <!-- Chat: Content-->
                        <div class="chat-content px-lg-8">
                            <div id="msg_box" class="container-xxl py-6 py-lg-10">

                                <!-- Divider -->
                                <div class="message-divider my-9 mx-lg-5">
                                    <div class="row align-items-center">

                                        <div class="col">
                                            <hr>
                                        </div>

                                        <div class="col-auto">
                                            <small class="text-muted">今日</small>
                                        </div>

                                        <div class="col">
                                            <hr>
                                        </div>
                                    </div>
                                </div>
                                <!-- Divider -->

                            </div>
<!--                            聊天窗口模板----------------------------------------------------------------->
                             <!-- Message -->
                                <div id="msg_tp_other" class="message" style="display: none;">
                                    <!-- Avatar -->
                                    <a class="avatar avatar-sm mr-4 mr-lg-5 msg_imgs" href="#">
                                        <img class="avatar-img msg_imga" src="static/assets/images/avatars/9.jpg" alt="">
                                        <div class="badge badge-sm badge-pill badge-primary badge-border-basic badge-bottom-right">
<!--                                            <span class="text-uppercase"></span>-->
                                            <samll class="msg_img_name">大牛皮我</samll>
                                        </div>
                                    </a>
                                    <a class="avatar avatar-sm ml-4 ml-lg-5 bg-primary text-white text-truncate msg_img_p" href="#">
                                        <span class="msg_img_pa">名称</span>
                                    </a> &nbsp;&nbsp;

                                    <!-- Message: body -->
                                    <div class="message-body">

                                        <!-- Message: row -->
                                        <div class="message-row">
                                            <div class="d-flex align-items-center">

                                                <!-- Message: content -->
                                                <div class="message-content bg-light">
                                                    <div class="msg_main">内容内容内容</div>

                                                    <div class="mt-1">
                                                        <small class="opacity-65 msg_time">8 mins ago</small>
                                                    </div>
                                                </div>
                                                <!-- Message: content -->

                                            </div>
                                        </div>
                                        <!-- Message: row -->

                                    </div>
                                    <!-- Message: body -->
                                </div>

                            <div id="msg_tp_other_p" class="message" style="display: none;">
                                    <!-- Avatar -->
                                    <a class="avatar avatar-sm mr-4 mr-lg-5 msg_imgs" href="#">
                                        <img class="avatar-img msg_imga" src="static/assets/images/avatars/9.jpg" alt="">
                                        <div class="badge badge-sm badge-pill badge-primary badge-border-basic badge-bottom-right">
<!--                                            <span class="text-uppercase"></span>-->
                                            <samll class="msg_img_name">大牛皮我</samll>
                                        </div>
                                    </a>
                                    <a class="avatar avatar-sm ml-4 ml-lg-5 bg-primary text-white text-truncate msg_img_p" href="#">
                                        <span class="msg_img_pa">名称</span>
                                    </a> &nbsp;&nbsp;

                                    <!-- Message: body -->
                                    <div class="message-body">

                                        <!-- Message: row -->
                                        <div class="message-row">
                                            <div class="d-flex align-items-center">

                                                <!-- Message: content -->
                                                <div class="message-content bg-dark text-white">
                                                    <div class="msg_main">内容内容内容</div>

                                                    <div class="mt-1">
                                                        <small class="opacity-65 msg_time">8 mins ago</small>
                                                    </div>
                                                </div>
                                                <!-- Message: content -->

                                            </div>
                                        </div>
                                        <!-- Message: row -->

                                    </div>
                                    <!-- Message: body -->
                                </div>
                                <!-- Message -->

                             <!-- Message -->
                                <div id="msg_tp_kp" class="message" style="display: none;">
                                    <!-- Avatar -->
                                    <a class="avatar avatar-sm mr-4 mr-lg-5 msg_imgs" href="#">
                                        <img class="avatar-img msg_imga" src="static/assets/images/avatars/9.jpg" alt="">
                                        <div class="badge badge-sm badge-pill badge-success badge-border-basic badge-bottom-right">
<!--                                            <span class="text-uppercase"></span>-->
                                            <samll class="msg_img_name">大牛皮我</samll>
                                        </div>
                                    </a>
                                    <a class="avatar avatar-sm ml-4 ml-lg-5 bg-success text-white text-truncate msg_img_p" href="#">
                                        <span class="msg_img_pa">名称</span>
                                    </a> &nbsp;&nbsp;

                                    <!-- Message: body -->
                                    <div class="message-body">

                                        <!-- Message: row -->
                                        <div class="message-row">
                                            <div class="d-flex align-items-center">

                                                <!-- Message: content -->
                                                <div class="message-content bg-light">
                                                    <div class="msg_main">内容内容内容</div>

                                                    <div class="mt-1">
                                                        <small class="opacity-65 msg_time">8 mins ago</small>
                                                    </div>
                                                </div>
                                                <!-- Message: content -->

                                            </div>
                                        </div>
                                        <!-- Message: row -->

                                    </div>
                                    <!-- Message: body -->
                                </div>


                            <div id="msg_tp_kp_p" class="message" style="display: none;">
                                    <!-- Avatar -->
                                    <a class="avatar avatar-sm mr-4 mr-lg-5 msg_imgs" href="#">
                                        <img class="avatar-img msg_imga" src="static/assets/images/avatars/9.jpg" alt="">
                                        <div class="badge badge-sm badge-pill badge-success badge-border-basic badge-bottom-right">
<!--                                            <span class="text-uppercase"></span>-->
                                            <samll class="msg_img_name">大牛皮我</samll>
                                        </div>
                                    </a>
                                    <a class="avatar avatar-sm ml-4 ml-lg-5 bg-success text-white text-truncate msg_img_p" href="#">
                                        <span class="msg_img_pa">名称</span>
                                    </a> &nbsp;&nbsp;

                                    <!-- Message: body -->
                                    <div class="message-body">

                                        <!-- Message: row -->
                                        <div class="message-row">
                                            <div class="d-flex align-items-center">

                                                <!-- Message: content -->
                                                <div class="message-content bg-dark text-white">
                                                    <div class="msg_main">内容内容内容</div>

                                                    <div class="mt-1">
                                                        <small class="opacity-65 msg_time">8 mins ago</small>
                                                    </div>
                                                </div>
                                                <!-- Message: content -->

                                            </div>
                                        </div>
                                        <!-- Message: row -->

                                    </div>
                                    <!-- Message: body -->
                                </div>
                                <!-- Message -->
<!--                                ---------------------------------------------------------------------------------------------------->

                                <!-- Message -->
                                <div id="msg_tp_my" class="message message-right" style="display: none;">
                                    <!-- Avatar -->
                                    <a href="#" class="avatar avatar-sm ml-4 ml-lg-5 msg_imgs">
                                        <img class="avatar-img msg_imga" src="static/assets/images/avatars/12.jpg" alt="" title="名称">
                                        <div class="badge badge-sm badge-pill badge-info badge-border-basic badge-bottom-left">
<!--                                            <span class="text-uppercase"></span>-->
                                            <samll class="msg_img_name">大牛皮我</samll>
                                        </div>
                                    </a>
                                     <a href="#" class="avatar avatar-sm ml-4 ml-lg-5 bg-primary text-white text-truncate msg_img_p">
                                                            <span class="msg_img_pa">名称</span>
                                                        </a>
                                    <!-- Message: body -->
                                    <div class="message-body">

                                        <!-- Message: row -->
                                        <div class="message-row">
                                            <div class="d-flex align-items-center justify-content-end">

                                                <!-- Message: content -->
                                                <div class="message-content bg-primary text-white">
                                                    <div class="msg_main">内容内容内容</div>

                                                    <div class="mt-1">
                                                        <small class="opacity-65 msg_time">8 mins ago</small>
                                                    </div>
                                                </div>
                                                <!-- Message: content -->

                                            </div>
                                        </div>
                                        <!-- Message: row -->

                                    </div>
                                    <!-- Message: body -->
                                </div>



                            <div id="msg_tp_my_p" class="message message-right" style="display: none;">
                                    <!-- Avatar -->
                                    <a href="#" class="avatar avatar-sm ml-4 ml-lg-5 msg_imgs">
                                        <img class="avatar-img msg_imga" src="static/assets/images/avatars/12.jpg" alt="" title="名称">
                                        <div class="badge badge-sm badge-pill badge-info badge-border-basic badge-bottom-left">
<!--                                            <span class="text-uppercase"></span>-->
                                            <samll class="msg_img_name">大牛皮我</samll>
                                        </div>
                                    </a>
                                     <a href="#" class="avatar avatar-sm ml-4 ml-lg-5 bg-primary text-white text-truncate msg_img_p">
                                                            <span class="msg_img_pa">名称</span>
                                                        </a>
                                    <!-- Message: body -->
                                    <div class="message-body">

                                        <!-- Message: row -->
                                        <div class="message-row">
                                            <div class="d-flex align-items-center justify-content-end">

                                                <!-- Message: content -->
                                                <div class="message-content bg-dark text-white">
                                                    <div class="msg_main">内容内容内容</div>

                                                    <div class="mt-1">
                                                        <small class="opacity-65 msg_time">8 mins ago</small>
                                                    </div>
                                                </div>
                                                <!-- Message: content -->

                                            </div>
                                        </div>
                                        <!-- Message: row -->

                                    </div>
                                    <!-- Message: body -->
                                </div>
                                <!-- Message -->
<!--                            聊天窗口模板----------------------------------------------------------------->



                            <!-- Scroll to end -->
                            <div class="end-of-chat"></div>
                        </div>
                        <!-- Chat: Content -->

                        <!-- Chat: DropzoneJS container -->

                        <!-- Chat: Footer -->
                        <div class="chat-footer border-top py-4 py-lg-6 px-lg-8">
                            <div class="container-xxl">

                                <div id="sent_more" class="form-row align-items-center" style="display: none;">
                                    <div class="col">
                                            <div class="input-group">







                                                <div>
                                                    <button onclick="creacy()" class="btn btn-ico btn-minimal" type="button" title="疯狂检定">
                                                        <i class="fe-target"></i>
                                                    </button>
                                                    <button id="showo_imgi" onclick="showo_img()" class="btn btn-ico btn-minimal"  data-toggle="modal" data-target="#dshowimg" type="button" title="显示图片">
                                                        <i class="fe-image"></i>
                                                    </button>
                                                    <button onclick="showo_img()" class="btn btn-ico btn-minimal" data-toggle="modal" data-target="#dnotebook" type="button" title="调查员笔记">
                                                        <i class="fe-book-open"></i>
                                                    </button>
                                                </div>
                                                <div>
                                                    <button id="cussaizi" class="btn btn-ico btn-minimal" type="button" title="特殊骰子" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        <i class="fe-slack"></i>
                                                    </button>
<!--                                                    筛子数字-->
                                                    <div class="dropdown-menu" aria-labelledby="cussaizi">
                                                        <a onclick="tou2(0,'d100',100);" class="dropdown-item" href="#!">d100</a>
                                                        <a onclick="tou2(0,'d50',50);" class="dropdown-item" href="#!">d50</a>
                                                        <a onclick="tou2(0,'d20',20);" class="dropdown-item" href="#!">d20</a>
                                                        <a onclick="tou2(0,'d10',10);" class="dropdown-item" href="#!">d10</a>
                                                        <a onclick="tou2(0,'d9',9);" class="dropdown-item" href="#!">d9</a>
                                                        <a onclick="tou2(0,'d8',8);" class="dropdown-item" href="#!">d8</a>
                                                        <a onclick="tou2(0,'d7',7);" class="dropdown-item" href="#!">d7</a>
                                                        <a onclick="tou2(0,'d6',6);" class="dropdown-item" href="#!">d6</a>
                                                        <a onclick="tou2(0,'d5',5);" class="dropdown-item" href="#!">d5</a>
                                                        <a onclick="tou2(0,'d4',4);" class="dropdown-item" href="#!">d4</a>
                                                        <a onclick="tou2(0,'d3',3);" class="dropdown-item" href="#!">d3</a>
                                                        <a onclick="tou2(0,'d2',2);" class="dropdown-item" href="#!">d2</a>
                                                    </div>
                                                </div>
                                                &nbsp;&nbsp;
                                                <select onchange="ssent()" id="send_toto" class="form-control custom-select">
                                                    <option value="public" selected="selected">公共信息</option>

                                                </select>
                                                <input id="send_toto_id" type="hidden" value="public" />
                                                <input id="send_toto_text" type="hidden" value="public" />
                                            </div>
                                        </div>
                                </div>
                                <div>
                                    <!--                                            调查员笔记-->
                                            <div class="modal fade" id="dnotebook" tabindex="-1" role="dialog" aria-labelledby="dnotebook" aria-hidden="true">
                                                <div class="modal-dialog" role="document" style="z-index: 2040">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">调查员笔记</h5>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <textarea id="dnotebook_v" class="form-control" rows="10"></textarea>
                                                        </div>
                                                        <div class="modal-footer">
                                                            <button onclick="send_note()" type="button" class="btn btn-primary">保存笔记</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
<!--                                            图片上传-->
                                            <div class="modal fade" id="dshowimg" tabindex="-1" role="dialog" aria-labelledby="dshowimg" aria-hidden="true">
                                                <div class="modal-dialog modal-xl" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-body">
                                                               <p align="center"><a href="#!" id="map-display-1"><img src="" class="img-fluid" alt="等待主持人上传图片..."></a></p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        <div class="modal fade" id="attackshow" tabindex="-1" role="dialog" aria-labelledby="attackshow" aria-hidden="true">
                                                <div class="modal-dialog" role="document" style="z-index: 2040">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">战斗方式</h5>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
<!--                                                            普通攻击列表-->
                                                            <div id="show_at_list"></div>
<!--                                                            反击列表-->
                                                            <div id="show_at_list2"></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
<!--                                                    战斗需要的模板-->
                                                    <div style="display: none;">
                                                        <a id="tmp_attackb" class="text-reset nav-link p-0 mb-6" href="#" onclick="">
                                                            <div class="card card-active-listener bg-light text-dark">
                                                                <div class="card-body">
                                                                    <div class="media">
                                                                        <div class="media-body overflow-hidden">
                                                                            <div class="d-flex align-items-center mb-1">
                                                                                <h6 class="text-truncate mb-0 mr-auto ttext">空手</h6>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </a>
                                                    </div>
                                </div>

                                    <div class="form-row align-items-center">
                                        <div class="col">
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <button onclick="$('#sent_more').toggle('fast')" class="btn btn-ico btn-minimal" type="button" title="更多">
                                                        <i class="fe-list"></i>
                                                    </button>
                                                </div>
                                                <textarea id="chat-id-1-input" class="form-control bg-transparent border-0" placeholder="人物卡加入游戏之后再输入..." rows="1" data-emoji-input="" data-autosize="true"></textarea>
                                            </div>
                                        </div>
                                            <!-- Submit button -->
                                        <div class="col-auto">
<!--                                            <button onclick="sub_send_msg()" class="btn btn-ico btn-primary rounded-circle" type="button">-->
<!--                                                <span class="fe-send"></span>-->
<!--                                            </button>-->
                                            <button id="sub_sendmsg" class="btn btn-ico btn-primary rounded-circle" type="button">
                                                <span class="fe-send"></span>
                                            </button>
                                        </div>

                                    </div>

                            </div>
                        </div>
                        <!-- Chat: Footer -->
                    </div>
                    <!-- Chat: body -->

                    <!-- Chat Details -->
                    <div id="chat-1-info" class="chat-sidebar">
                        <div class="d-flex h-100 flex-column">

                            <!-- Header -->
                            <div class="border-bottom py-4 py-lg-6">
                                <div class="container-fluid">

                                    <ul class="nav justify-content-between align-items-center">
                                        <!-- Close sidebar -->
                                        <li class="nav-item list-inline-item">
                                            <a class="nav-link text-muted px-0" href="#" data-chat-sidebar-close="">
                                                <i class="icon-md fe-chevron-left"></i>
                                            </a>
                                        </li>

                                        <!-- Title(mobile) -->
                                        <li class="text-center d-block d-lg-none">
<!--                                            <h6 class="mb-n2">房间名称</h6>-->
<!--                                            <small class="text-muted">房间信息</small>-->
                                        </li>

                                        <!-- Dropdown -->
                                        <li id="delet_room_list" class="nav-item list-inline-item">
                                            <div class="dropdown">
                                                <a class="nav-link text-muted px-0" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <i class="icon-md fe-sliders"></i>
                                                </a>
                                                <div class="dropdown-menu">
<!--                                                    <a class="dropdown-item d-flex align-items-center" href="#">-->
<!--                                                        编辑房间-->
<!--                                                        <span class="ml-auto fe-edit"></span>-->
<!--                                                    </a>-->
<!--                                                    <a onclick="" class="dropdown-item d-flex align-items-center" href="#" data-chat-sidebar-toggle="#chat-2-info">-->
<!--                                                        上传图片-->
<!--                                                        <span class="ml-auto fe-map"></span>-->
<!--                                                    </a>-->
                                                    <a onclick="clear_msg({{group_id}})" class="dropdown-item d-flex align-items-center" href="#">
                                                        清除对话
                                                        <span class="ml-auto fe-inbox"></span>
                                                    </a>
                                                    <a onclick="delet_room({{group_id}})" class="dropdown-item d-flex align-items-center" href="#">
                                                        删除房间
                                                        <span class="ml-auto fe-trash-2"></span>
                                                    </a>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                </div>
                            </div>
                            <!-- Header -->

                            <!-- Body -->
                            <div class="hide-scrollbar flex-fill">

                                <div class="border-bottom text-center py-9 px-10">
                                    <!-- Photo -->
                                    {% for gd in group_deteil %}
                                        {% if gd.1==74 %}
                                            {% if gd.2=="0" %}
                                            <div class="avatar avatar-xl mx-5 mb-5 bg-primary text-white text-truncate">
                                                <span class="room_name_p">{{group_name}}</span>
                                            </div>
                                            {% else %}
                                            <div class="avatar avatar-xl mx-5 mb-5">
                                                <img class="avatar-img" src="{{gd.2}}" alt="{{group_name}}">
                                            </div>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}

                                    <h5>{{group_name}}</h5>
                                    <p class="text-muted">
                                        {% for gd in group_deteil %}
                                        {% if gd.1==69 %}
                                        类型:{{gd.2}}&nbsp;&nbsp;
                                        {% elif gd.1==70 %}
                                        最大人数:{{gd.2}}</p>
                                        {% elif gd.1==71 %}
                                    <p><a class="text-dark" data-toggle="collapse" href="#jianjie1" role="button" aria-expanded="false" aria-controls="jianjie1">
                                        <small>点击查看房间简介 </small></a></p>
                                    <div class="collapse" id="jianjie1">
                                        <p>{{gd.2}}</p>
                                            </div>
                                        {% endif %}
                                        {% endfor %}

                                </div>

                                <!-- Navs -->
                                <ul class="nav nav-tabs nav-justified bg-light rounded-0" role="tablist">
                                    <li class="nav-item">
                                        <a id="wanjialiebiao" href="#chat-id-1-members" class="nav-link active" data-toggle="tab" role="tab" aria-selected="true">玩家列表</a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="#chat-id-1-files" class="nav-link" data-toggle="tab" role="tab">人物卡列表</a>
                                    </li>
                                </ul>
                                <!-- Navs -->

                                <div class="tab-content">
                                    <!-- 玩家列表 -->
                                    <div id="chat-id-1-members" class="tab-pane fade show active">
                                        <ul id="list_players" class="list-group list-group-flush list-group-no-border-first">



                                        </ul>
                                        <!-- 人物列表模板 -->
                                            <li id="tp_list_rp" style="display: none;" class="list-group-item py-6">
                                                <div class="media align-items-center">

                                                    <div class="avatar mr-5 bg-secondary text-white text-truncate rp_name_pt">
                                                            <span class="rp_name_p"></span>
                                                        </div>
                                                    <div class="avatar avatar-offline avatar-sm mr-5 rp_pict">
                                                        <img class="avatar-img rp_pic" src="static/assets/images/avatars/3.jpg" />
                                                    </div>

                                                    <div class="media-body">
                                                        <h6 class="mb-0">
                                                            <a href="#" class="text-reset rp_name">名称</a>
                                                        </h6>
                                                        <small class="text-muted rp_work"></small>
                                                    </div>

                                                    <div class="align-self-center ml-5 rp_rightcli">
                                                        <div class="dropdown">
                                                            <a href="#" class="btn btn-sm btn-ico btn-link text-muted w-auto" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="fe-more-vertical"></i>
                                                            </a>
                                                            <div class="dropdown-menu">
                                                                <a onclick="add_game()" class="dropdown-item d-flex align-items-center rp_getinfo" href="#">
                                                                    加入游戏 <span class="ml-auto fe-plus"></span>
                                                                </a>
<!--                                                                <a class="dropdown-item d-flex align-items-center" href="#">-->
<!--                                                                    踢出游戏 <span class="ml-auto fe-user-x"></span>-->
<!--                                                                </a>-->
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </li>
                                            <!-- 人物列表模板 -->
                                    </div>
                                    <!-- 玩家列表 -->

                                    <!-- NPC列表 -->
                                    <div id="chat-id-1-files" class="tab-pane fade">
                                        <ul id="list_npc" class="list-group list-group-flush list-group-no-border-first">
                                            <!-- Member -->
                                            <li class="list-group-item py-6">
                                                <div class="media align-items-center">



                                                    <div class="avatar avatar-sm mr-5">
                                                        <img class="avatar-img" src="static/assets/images/avatars/3.jpg" alt="William Greer">
                                                    </div>

                                                    <div class="media-body">
                                                        <h6 class="mb-0">
                                                            <a href="#" class="text-reset">William Greer</a>
                                                        </h6>
                                                        <small class="text-muted">last seen 10 minutes ago</small>
                                                    </div>

                                                    <div class="align-self-center ml-5">
                                                        <div class="dropdown">
                                                            <a href="#" class="btn btn-sm btn-ico btn-link text-muted w-auto" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="fe-more-vertical"></i>
                                                            </a>
                                                            <div class="dropdown-menu">
                                                                <a class="dropdown-item d-flex align-items-center" href="#">
                                                                    Promote <span class="ml-auto fe-trending-up"></span>
                                                                </a>
                                                                <a class="dropdown-item d-flex align-items-center" href="#">
                                                                    Restrict <span class="ml-auto fe-trending-down"></span>
                                                                </a>
                                                                <a class="dropdown-item d-flex align-items-center" href="#">
                                                                    Delete <span class="ml-auto fe-user-x"></span>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </li>
                                            <!-- Member -->
                                            <!-- Member -->
                                            <li class="list-group-item py-6">
                                                <div class="media align-items-center">



                                                    <div class="avatar avatar-sm mr-5">
                                                        <img class="avatar-img" src="static/assets/images/avatars/3.jpg" alt="William Greer">
                                                    </div>

                                                    <div class="media-body">
                                                        <h6 class="mb-0">
                                                            <a href="#" class="text-reset">William Greer</a>
                                                        </h6>
                                                        <small class="text-muted">last seen 10 minutes ago</small>
                                                    </div>

                                                    <div class="align-self-center ml-5">
                                                        <div class="dropdown">
                                                            <a href="#" class="btn btn-sm btn-ico btn-link text-muted w-auto" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                <i class="fe-more-vertical"></i>
                                                            </a>
                                                            <div class="dropdown-menu">
                                                                <a class="dropdown-item d-flex align-items-center" href="#">
                                                                    Promote <span class="ml-auto fe-trending-up"></span>
                                                                </a>
                                                                <a class="dropdown-item d-flex align-items-center" href="#">
                                                                    Restrict <span class="ml-auto fe-trending-down"></span>
                                                                </a>
                                                                <a class="dropdown-item d-flex align-items-center" href="#">
                                                                    Delete <span class="ml-auto fe-user-x"></span>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>

                                                </div>
                                            </li>
                                            <!-- Member -->

                                        </ul>
                                    </div>
                                    <!-- NPC列表 -->
                                </div>
                            </div>
                            <!-- Body -->

                        </div>
                    </div>
                    <!-- Chat Details -->

                    <!-- New members -->
                    <div id="chat-1-members" class="chat-sidebar">
                        <div class="d-flex h-100 flex-column">

                            <!-- Header -->
                            <div class="border-bottom py-4 py-lg-6">
                                <div class="container-fluid">

                                    <ul class="nav justify-content-between align-items-center">
                                        <!-- Close sidebar -->
                                        <li class="nav-item">
                                            <a class="nav-link text-muted px-0" href="#" data-chat-sidebar-close="">
                                                <i class="icon-md fe-chevron-left"></i>
                                            </a>
                                        </li>

                                        <!-- Title(mobile) -->
                                        <li class="text-center d-block d-lg-none">
                                            <h6 class="mb-n2">Bootstrap Themes</h6>
                                            <small class="text-muted">Add Members</small>
                                        </li>

                                        <!-- Dropdown -->
                                        <li class="nav-item">
                                            <div class="dropdown">
                                                <a class="nav-link text-muted px-0" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                    <i class="icon-md fe-sliders"></i>
                                                </a>
                                                <div class="dropdown-menu">
                                                    <a class="dropdown-item d-flex align-items-center" href="#">
                                                        Mute
                                                        <span class="ml-auto fe-bell"></span>
                                                    </a>
                                                    <a class="dropdown-item d-flex align-items-center" href="#">
                                                        Delete
                                                        <span class="ml-auto fe-trash-2"></span>
                                                    </a>
                                                </div>
                                            </div>
                                        </li>
                                    </ul>

                                </div>
                            </div>
                            <!-- Header -->

                            <!-- Body -->
                            <div class="hide-scrollbar flex-fill">
                                <!-- Search -->
                                <div class="border-bottom py-7">
                                    <div class="container-fluid">

                                        <form action="#">
                                            <div class="input-group">
                                                <input type="text" class="form-control form-control-lg" placeholder="Search for users..." aria-label="Search users...">
                                                <div class="input-group-append">
                                                    <button class="btn btn-lg btn-ico btn-secondary btn-minimal" type="submit">
                                                        <i class="fe-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </form>

                                    </div>
                                </div>
                                <!-- Search -->

                                <!-- Members -->
                                <form action="#">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item py-4">
                                            <small class="text-uppercase">A</small>
                                        </li>

                                        <!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                <div class="avatar avatar-sm avatar-online mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/10.jpg" alt="Anna Bridges">
                                                </div>
                                                
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">Anna Bridges</h6>
                                                    <small class="text-muted">Online</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-1" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-1"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-1"></label>
                                        </li>
                                        <!-- Member -->


                                        <li class="list-group-item py-4">
                                            <small class="text-uppercase">B</small>
                                        </li>

                                        <!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                
                                                <div class="avatar avatar-sm mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/6.jpg" alt="Brian Dawson">
                                                </div>
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">Brian Dawson</h6>
                                                    <small class="text-muted">last seen 2 hours ago</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-2" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-2"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-2"></label>
                                        </li>
                                        <!-- Member -->


                                        <li class="list-group-item py-4">
                                            <small class="text-uppercase">L</small>
                                        </li>

                                        <!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                
                                                <div class="avatar avatar-sm mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/5.jpg" alt="Leslie Sutton">
                                                </div>
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">Leslie Sutton</h6>
                                                    <small class="text-muted">last seen 3 days ago</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-3" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-3"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-3"></label>
                                        </li>
                                        <!-- Member -->


                                        <li class="list-group-item py-4">
                                            <small class="text-uppercase">M</small>
                                        </li>

                                        <!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                
                                                <div class="avatar avatar-sm mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/4.jpg" alt="Matthew Wiggins">
                                                </div>
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">Matthew Wiggins</h6>
                                                    <small class="text-muted">last seen 3 days ago</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-4" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-4"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-4"></label>
                                        </li>
                                        <!-- Member -->


                                        <li class="list-group-item py-4">
                                            <small class="text-uppercase">S</small>
                                        </li>

                                        <!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                
                                                <div class="avatar avatar-sm mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/7.jpg" alt="Simon Hensley">
                                                </div>
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">Simon Hensley</h6>
                                                    <small class="text-muted">last seen 3 days ago</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-5" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-5"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-5"></label>
                                        </li>
                                        <!-- Member -->


                                        <li class="list-group-item py-4">
                                            <small class="text-uppercase">W</small>
                                        </li>

                                        <!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                
                                                <div class="avatar avatar-sm mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/9.jpg" alt="William Wright">
                                                </div>
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">William Wright</h6>
                                                    <small class="text-muted">last seen 3 days ago</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-6" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-6"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-6"></label>
                                        </li>
                                        <!-- Member -->
<!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                
                                                <div class="avatar avatar-sm mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/3.jpg" alt="William Greer">
                                                </div>
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">William Greer</h6>
                                                    <small class="text-muted">last seen 10 minutes ago</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-7" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-7"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-7"></label>
                                        </li>
                                        <!-- Member -->


                                        <li class="list-group-item py-4">
                                            <small class="text-uppercase">Z</small>
                                        </li>

                                        <!-- Member -->
                                        <li class="list-group-item py-6">
                                            <div class="media align-items-center">

                                                
                                                
                                                <div class="avatar avatar-sm mr-5">
                                                    <img class="avatar-img" src="static/assets/images/avatars/7.jpg" alt="Zane Mayes">
                                                </div>
                                                
                                                <div class="media-body">
                                                    <h6 class="mb-0">Zane Mayes</h6>
                                                    <small class="text-muted">last seen 3 days ago</small>
                                                </div>

                                                <div class="align-self-center ml-auto">
                                                    <div class="custom-control custom-checkbox">
                                                        <input class="custom-control-input" id="id-add-user-chat-1-user-8" type="checkbox">
                                                        <label class="custom-control-label" for="id-add-user-chat-1-user-8"></label>
                                                    </div>
                                                </div>

                                            </div>

                                            <!-- Label -->
                                            <label class="stretched-label" for="id-add-user-chat-1-user-8"></label>
                                        </li>
                                        <!-- Member -->

                                    </ul>
                                </form>
                                <!-- Members -->
                            </div>
                            <!-- Body -->

                            <!-- Button -->
                            <div class="border-top py-7">
                                <div class="container-fluid">
                                    <button class="btn btn-lg btn-block btn-primary d-flex align-items-center" type="submit">
                                        Add members
                                        <span class="fe-user-plus ml-auto"></span>
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>
                    <!-- New members -->

                {% include 'dist/user_deteil.html' %}

                </div>
                <!-- Chat -->

            </div>
            <!-- Main Content -->

            <!-- Active Users: Sidebar -->

            <!-- Active Users: Sidebar -->

        </div>
        <!-- Layout -->

        <!-- DropzoneJS: Template -->
        <!-- DropzoneJS: Template -->

        <!-- Modal: Invite friends -->
        <div class="modal fade" id="invite-friends" tabindex="-1" role="dialog" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">

                    <div class="modal-header">
                        <div class="media flex-fill">
                            <div class="icon-shape rounded-lg bg-primary text-white mr-5">
                                <i class="fe-users"></i>
                            </div>
                            <div class="media-body align-self-center">
                                <h5 class="modal-title">Invite friends</h5>
                                <p class="small">Invite colleagues, clients and friends.</p>
                            </div>
                        </div>

                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>

                    <div class="modal-body">
                        <form action="#">
                            <div class="form-group">
                                <label for="invite-email" class="small">Email</label>
                                <input type="text" class="form-control form-control-lg" id="invite-email">
                            </div>

                            <div class="form-group mb-0">
                                <label for="invite-message" class="small">Invitation message</label>
                                <textarea class="form-control form-control-lg" id="invite-message" data-autosize="true"></textarea>
                            </div>
                        </form>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-lg btn-block btn-primary d-flex align-items-center">
                            Invite friend
                            <i class="fe-user-plus ml-auto"></i>
                        </button>
                    </div>

                </div>
            </div>
        </div>
        <!-- Modal: Invite friends -->
<!--        缓存-->
        <div id="temp_list" class="d-none">

        </div>

    <script>
        //战斗房间id
        var fight_id_g;
        //战斗方式
        var attack_method;
        //攻击来自id
        var attack_fromid=0;
        var pids = new Array();
        var noteid=0;
        var mycid=0;
        var lastid=0;
        var liliang;
        var tizhi;
        var tixing;
        var yizhi;
        var namespace = '/chat';
        var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);
        socket.on('connect', function() {
             socket.emit('join', {userid:"{{myuid}}",roomid: "{{group_id}}"});
            {% if page=="roomp" %}
            if(mycid && mycid!=0){
                var toidp="{{group_creater}}";
                var myname = $("#dtt_myname").val();
                var mypic = $("#dtt_mypic").val();
                var newmsg = myname+"加入游戏"
                socket.emit('send_msg', {data: newmsg, userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic, kind:2, toidp:toidp, t:0, nosend:1});
            }
            {% endif %}
        });
        $(document).ready(function() {

            $('<audio id="chatAudio"><source src="static/msg.mp3" type="audio/mpeg"></audio>').appendTo('body');

            get_kazu("mykazu","list_npc","tp_list_rp","list_rp_");
            get_kazu("allkazu","list_players","tp_list_rp","list_pp_");
            get_msg_lastid(1);
            // 显示右边的信息框
            $("#chat-1-info").attr("class","chat-sidebar chat-sidebar-visible");
            {% if page=="roomp" %}
            //如果不是房间创建人去掉删除按钮
            $("#delet_room_list").hide();
            {% endif %}
            //获取用户数据

            //心跳包
            setInterval(function(){
                socket.emit('join2', {userid:"{{myuid}}",roomid: "{{group_id}}"});
            },60000);

            //获取显示图片列表
            show_imgs();
            //显示已标记显示的图片

            $(document).on("click",".file-list-template-display",function () {
              var displayimgurl = $(this).parent().attr("imgurl");
              //need：后台根据图片名称 显示给其他玩家 对应的图片 $post
              $("#map-display-1").find("img").attr("src",displayimgurl)
            });


           $(document).on("click",".file-list-template-delete",function () {
             var deleteimgurl = $(this).parent().attr("imgurl");
             //need：后台根据文件名 删除对应文件 $post
             // console.log(deleteimgurl);
             del_img(deleteimgurl);
             $(this).parent().parent().parent().parent().parent().remove();

           });



        //    socket 聊天室


            socket.on('disconnect', function() {
                socket.emit('leave', {userid:"{{myuid}}",roomid: "{{group_id}}"});
            });

            socket.on('mem_join', function(msg) {
                // console.log(msg);
                if(msg['userid'] != "{{myuid}}"){
                    console.log("refresh");
                    get_kazu("allkazu","list_players","tp_list_rp","list_pp_");
                }
            });

            socket.on('my_response', function(msg) {
                console.log(msg);
            });
            socket.on('get_change', function(data) {
                //kp修改过之后用户自动修改
                // $("#"+data['listid']).val(data['value']);
                get_kazu("mykazu","list_npc","tp_list_rp","list_rp_");
            });
            //修改一个用户的参数
            socket.on('get_change_one', function(data) {
                $("#"+data['listid']).val(data['value']);
                $("#"+data['listid']).trigger("change");
            });

            socket.on('get_msg', function(data) {
                var xiala = 0
                var name = data['myname'];
                var pic =data['mypic'];
                var msga =data['data'];
                var uid =data['userid'];
                var kind =data['kind'];
                xiala = data['xiala'];
                // var toidp =data['toidp'];
                // console.log(data);
                var timestamp=new Date().getTime();
                var radn = randomNum(1000,9999);
                var sia = timestamp+radn;
                t = data['t'];
                if(uid == "{{myuid}}"){
                    var mytemp = "msg_my_";
                    var tmp_se = "msg_tp_my";
                }
                else if(uid == "{{group_creater}}"){
                    var mytemp = "msg_oth_";
                    var tmp_se = "msg_tp_kp";
                }
                else{
                    var mytemp = "msg_oth_";
                    var tmp_se = "msg_tp_other";
                }
                //2私信 5公共信息
                if(kind==2){
                    tmp_se = tmp_se+"_p"
                }
                set_msg_box2(sia,"msg_box",tmp_se,mytemp,name,pic,msga,uid,t,xiala);
                if(uid!="{{myuid}}"){
                    $('#chatAudio')[0].play();
                }
                else{
                    if(data['type'] && data['type']=="mobile"){
                        $("#chat-1-user-profile").attr("class","chat-sidebar");
                    }
                }
            });

            socket.on('ch_v', function(data) {
                var sid = "0";
                if(data["type"]=="hp"){
                    sid = "va2_29";
                }
                else if(data["type"]=="san"){
                    sid = "va2_30";
                }
                $("#"+sid).val(data["value"]);
            });

            //kp传送给玩家自动投的
            socket.on('reng_p', function (data) {
                var pid = "{{myuid}}";
                var roll_t = data['roll_t'];
                var pc_t = data['pc_t'];
                var f_id = data['f_id'];
                if(roll_t=="SPD"){
                    tou3f('va2_23','敏捷',0,roll_t,parseInt(pid),pc_t,f_id);
                }
            });
            //战斗结果数据接收
            socket.on('get_f_info', function(data) {
                get_f_info_fun(data);
            });

            {% if page=="roomc" %}
            //加入战斗
            socket.on('f_join', function(data) {
                var fight_id = data['fightid'];
                var join_ppl = {id:parseInt(data['userid']),type:2,name:data['pname'],hp:parseInt(data['hp']),hp_max:parseInt(data['hp']),con:parseInt(data['con']),
                    wil:parseInt(data['wil']),armo:0,speed:parseInt(data['spd_lv']),spd_v:parseInt(data['spd_v']),finish:1,at_lv:0,at_v:0,at_target:0,at_type:0,de_lv:0,de_v:0,de_type:0,status:0};
                for(ii in mon_fi_now){
                    if(mon_fi_now[ii][0]==fight_id){
                        mon_fi_now[ii][3].push(join_ppl);
                        break;
                    }
                }
                console.log(mon_fi_now);
                //id,类型,名称,体力,盔甲,敏捷检定
            });
            {% endif %}

            $('#sub_sendmsg').click(function() {
                if(mycid==0 || mycid=="0" || !mycid){
                    alert("请至少将一个卡组加入游戏再输入");
                    return
                }
                var value = $("#chat-id-1-input").val();
                if(!value){
                    alert("请输入内容再提交");
                    $("#chat-id-1-input").focus();
                    return;
                }
                var toto = $("#send_toto_id").val();
                var totext = $("#send_toto_text").val();
                if(toto=="public"){
                    var kind=5;
                    var toidp=0;
                }
                else{
                    var kind=2;
                    var toidp=toto;
                    value = "To "+totext+":<br/>"+value;
                }
                var myname = $("#dtt_myname").val();
                var mypic = $("#dtt_mypic").val();

                socket.emit('send_msg', {data: value, userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic, kind:kind, toidp:toidp, t:0});
                $("#chat-id-1-input").val("");
            });

        });

        $("[data-toggle='tooltip']").tooltip({
        //指定显示时延迟和消失时延迟
        delay: {show: 50, hide: 100}
        });

        //获取职业描述
        function get_winfo(id,showid){
            $.get("/getwinfo", {
                nid : id,
              },
                function(myData , status){
                    if(myData!=0){
                        var teshu = myData[1];
                        $("#"+showid).append("<p>职业特殊:"+teshu+"</p>");
                    }
            },"json");
        }

        //获取卡组
        function get_kazu(method, list, templates, mytemp) {
            $.get("/getkazu", {
                method: method,
                gid:"{{group_id}}"
              },
                function(myData , status){
                //     卡组首页信息
                //     卡组具体信息
                //     工作
                //     console.log(myData);
                    if(method=="allkazu"){
                        var ht = '<option value="public" selected="selected">公共信息</option>';
                        $("#send_toto").html(ht);
                    }
                    $("#temp_list").html("");
                    for(data of myData){
                        var cid = data[0][0];
                        if(cid=="0"){
                            continue;
                        }
                        var uid = data[0][1];
                        var pname = data[0][5];
                        if(data[2]!="0"){
                            var work = data[2][0];
                            var workname = work[2];
                        }
                        else{
                            var work = 0;
                            var workname = "未设定职业";
                        }
                        var ifonline = data[3];

                        // 私信的地方加入玩家列表
                        if(method=="allkazu"){
                            var list_pl = "<option value='"+uid+"'>"+pname+"</option>";
                            $("#send_toto").prepend(list_pl);
                        }

                        //在玩家列表中列出来
                        var cc = $("#"+templates).clone(true);
                        cc.attr('id',mytemp+cid);
                        // cc.attr('href',"roomc?rid="+roomid);
                        cc.attr('style','');
                        // $("#"+list).append(cc);
                        $("#temp_list").append(cc);
                        $("#"+mytemp+cid+" .rp_name").html(pname);
                        // 设定点击查看详细信息
                        $("#"+mytemp+cid+" .rp_name").attr("onclick","show_deteils("+cid+","+uid+",'"+workname+"')");
                        if(uid=={{myuid}} || "{{page}}"=="roomc"){
                            if(method=="allkazu"){
                                $("#"+mytemp+cid+" .rp_getinfo").attr("onclick","del_game("+cid+","+uid+")");
                            }
                            else if(method=="mykazu"){
                                $("#"+mytemp+cid+" .rp_getinfo").attr("onclick","add_game("+cid+",'"+pname+"')");
                            }
                        }
                        else{
                            $("#"+mytemp+cid+" .rp_rightcli").hide();
                        }

                        if(method=="allkazu"){
                            if(uid=={{myuid}}){
                                mycid = cid;
                                $("#dtt_mycid").val(mycid);
                                $("#dtt_myuid").val(uid);
                                $("#dtt_myname").val(pname);
                                $("#dtt_myjobname").val(workname);
                                show_myde();
                                $("#chat-id-1-input").attr("placeholder","输入信息...");
                                var outtext="退出游戏";
                            }
                            else{
                                var outtext="踢出游戏";
                            }
                            $("#"+mytemp+cid+" .rp_getinfo").html(outtext+" <span class=\"ml-auto fe-user-x\"></span>");
                        }
                        $("#"+mytemp+cid+" .rp_work").html("职业:"+workname);
                        for(dd of data[1]){
                            if(dd[3]=='75'){
                                if(dd[5]==0){
                                    $("#"+mytemp+cid+" .rp_pict").hide();
                                    $("#"+mytemp+cid+" .rp_name_p").html(pname);
                                    if(ifonline==1){
                                        $("#"+mytemp+cid+" .rp_name_pt").removeClass("bg-secondary");
                                        $("#"+mytemp+cid+" .rp_name_pt").addClass("bg-primary");
                                    }
                                }
                                else{
                                    $("#"+mytemp+cid+" .rp_name_pt").hide();
                                    $("#"+mytemp+cid+" .rp_pic").attr('src',dd[5]);
                                    if(mycid){
                                        if(uid=="{{myuid}}" && dd[7]==mycid){
                                            $("#dtt_mypic").val(dd[5]);
                                        }
                                    }
                                    if(ifonline==1){
                                        $("#"+mytemp+cid+" .rp_pict").removeClass("avatar-offline");
                                        $("#"+mytemp+cid+" .rp_pict").addClass("avatar-online");
                                    }
                                }
                            }
                        }
                    }
                    $("#"+list).html($("#temp_list").html());
                    $("#temp_list").html("");
                },"json");
        }

        //----------------------------------------------------------------message
        //获取最后一个id
        function get_msg_lastid(silence=0){
            $.get("/getmsg_lastid", {
                gid:"{{group_id}}"
              },
            function(myData , status){
                myData=parseInt(myData);
                if(myData!=0){
                    if(lastid!=myData){
                        lastid=myData;
                        get_msg(silence);
                    }
                }

            });
        }

        // 获取message
        function get_msg(silence=0){
            $.get("/getmsg_group", {
                gid:"{{group_id}}"
              },
            function(myData , status){
                $("#msg_box").html("");
                myData = myData.reverse();
                var lastidd=0;
                for(data of myData){
                    var uid = data[0];
                    var name = data[1];
                    var pic = data[2];
                    var msga = data[3];
                    var kind = msga[1];
                    var timestamp=new Date().getTime();
                    var radn = randomNum(1000,9999);
                    var sia = timestamp+radn;
                    if(kind==2){
                        if(uid == "{{myuid}}"){
                            var mytemp = "msg_my_";
                            set_msg_box(sia,"msg_box","msg_tp_my_p",mytemp,name,pic,msga,uid);
                        }
                        else if(uid == "{{group_creater}}"){
                            var mytemp = "msg_oth_";
                            set_msg_box(sia,"msg_box","msg_tp_kp_p",mytemp,name,pic,msga,uid);
                        }
                        else{
                            // console.log(name);
                            var mytemp = "msg_oth_";
                            set_msg_box(sia,"msg_box","msg_tp_other_p",mytemp,name,pic,msga,uid);
                        }

                    }
                    else{
                        if(uid == "{{myuid}}"){
                            var mytemp = "msg_my_";
                            set_msg_box(sia,"msg_box","msg_tp_my",mytemp,name,pic,msga,uid);
                        }
                        else if(uid == "{{group_creater}}"){
                            var mytemp = "msg_oth_";
                            set_msg_box(sia,"msg_box","msg_tp_kp",mytemp,name,pic,msga,uid);
                        }
                        else{
                            // console.log(name);
                            var mytemp = "msg_oth_";
                            set_msg_box(sia,"msg_box","msg_tp_other",mytemp,name,pic,msga,uid);
                        }
                    }

                    lastidd = "#"+mytemp+sia;
                }
                var scrollHeight = $('#msg_box').prop("scrollHeight");
                $('.chat-content').animate({scrollTop:scrollHeight},0);
                if(silence!=1){
                    $('#chatAudio')[0].play();
                }
            });
        }
        function set_msg_box(sid,list, templates, mytemp,name,pic,msga,uid=0){
            var cc = $("#"+templates).clone(true);
            cc.attr('id',mytemp+sid);
            cc.attr('style','');
            $("#"+list).append(cc);
            if(pic=="0"){
                $("#"+mytemp+sid+" .msg_imgs").hide();
                if(uid!=0){
                    if(uid == "{{myuid}}"){
                        uid = "public";
                    }
                    $("#"+mytemp+sid+" .msg_img_p").attr("onclick", "ssent("+uid+", '"+name+"')");
                }
                $("#"+mytemp+sid+" .msg_img_pa").html(name);
            }
            else{
                $("#"+mytemp+sid+" .msg_img_p").hide();
                if(uid!=0){
                    if(uid == "{{myuid}}"){
                        uid = "public";
                    }
                    $("#"+mytemp+sid+" .msg_imgs").attr("onclick", "ssent('"+uid+"', '"+name+"')");
                }
                $("#"+mytemp+sid+" .msg_imga").attr("src",pic);
                $("#"+mytemp+sid+" .msg_img_name").html(name);
            }
            // $("#"+mytemp+sid+" .msg_imgs").attr("href","#"+mytemp+sid);
            var showmsg = msga[6];
            showmsg = cha("img",showmsg);
            showmsg = cha("txt",showmsg);
            showmsg = cha("dian",showmsg);
            showmsg = cha("tou",showmsg);
            $("#"+mytemp+sid+" .msg_main").html(showmsg);
            var msg_time = currentTime(parseInt(msga[5]));
            $("#"+mytemp+sid+" .msg_time").html(msg_time);
        }

        function set_msg_box2(sid,list, templates, mytemp,name,pic,msga,uid=0,ttime=0,xiala=0){
            var cc = $("#"+templates).clone(true);
            cc.attr('id',mytemp+sid);
            cc.attr('style','');
            $("#"+list).append(cc);
            if(pic=="0"){
                $("#"+mytemp+sid+" .msg_imgs").hide();
                if(uid!=0){
                    if(uid == "{{myuid}}"){
                        uid = "public";
                    }
                    $("#"+mytemp+sid+" .msg_img_p").attr("onclick", "ssent("+uid+", '"+name+"')");
                }
                $("#"+mytemp+sid+" .msg_img_pa").html(name);
            }
            else{
                $("#"+mytemp+sid+" .msg_img_p").hide();
                if(uid!=0){
                    if(uid == "{{myuid}}"){
                        uid = "public";
                    }
                    $("#"+mytemp+sid+" .msg_imgs").attr("onclick", "ssent('"+uid+"', '"+name+"')");
                }
                $("#"+mytemp+sid+" .msg_imga").attr("src",pic);
                $("#"+mytemp+sid+" .msg_img_name").html(name);
            }
            // $("#"+mytemp+sid+" .msg_imgs").attr("href","#"+mytemp+sid);
            var showmsg = msga;
            showmsg = cha("img",showmsg);
            showmsg = cha("txt",showmsg);
            showmsg = cha("dian",showmsg);
            showmsg = cha("tou",showmsg);
            $("#"+mytemp+sid+" .msg_main").html(showmsg);
            var msg_time = currentTime(parseInt(ttime));
            $("#"+mytemp+sid+" .msg_time").html(msg_time);
            if(xiala!=1){
                var scrollHeight = $('#'+list).prop("scrollHeight");
                $('.chat-content').animate({scrollTop:scrollHeight},0);
            }
        }

        //修改私信去向
        function ssent(toto=0, totext=0) {
            if(toto==0){
                toto = $("#send_toto").val();
            }
            if(totext==0){
                totext = $("#send_toto").find("option:selected").text();
            }
            $("#send_toto_id").val(toto);
            $("#send_toto_text").val(totext);
            if(toto=="public"){
                $("#chat-id-1-input").attr("placeholder","输入信息...");
            }
            else{
                $("#chat-id-1-input").attr("placeholder","向 "+totext+" 发送私信..");
            }
        }
        //按发送键
        function sub_send_msg() {
            var value = $("#chat-id-1-input").val();
            if(!value){
                alert("请输入内容再提交");
                $("#chat-id-1-input").focus();
                return;
            }
            var toto = $("#send_toto_id").val();
            var totext = $("#send_toto_text").val();
            if(toto=="public"){
                var kind=5;
                var toidp=0;
            }
            else{
                var kind=2;
                var toidp=toto;
                value = "To "+totext+":<br/>"+value;
            }
            send_msg(value, kind, toidp);
        }
        //发送信息
        function send_msg(v=0, kind=5, toidp=0, xiala=0) {
            if(mycid==0 || mycid=="0" || !mycid){
                alert("请至少将一个卡组加入游戏再输入");
                return
            }
            if(v==0){
                var value = $("#chat-id-1-input").val();
                if(!value){
                    alert("请输入内容再提交");
                    $("#chat-id-1-input").focus();
                    return;
                }
            }
            else {
                var value = v;
            }
            if(toidp=="kp"){
                toidp="{{group_creater}}";
            }
            var myname = $("#dtt_myname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('send_msg', {data: value, userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic, kind:kind, toidp:toidp, t:0, xiala:xiala});
            $("#chat-id-1-input").val("");
        }
        //----------------------------------------------------------------message

        //----------------------------------------------------------------人物卡
        //列出人物卡详细信息
        function show_deteils(cid,uid,jobname) {
            {% if page=="roomp" %}
            if (uid!={{myuid}}){
                alert("您没有权限看别人的角色卡!");
                return;
            }
            {% endif %}

            $("#chat-1-info").attr("class","chat-sidebar");
            $("#chat-1-user-profile").attr("class","chat-sidebar chat-sidebar-visible");

            $("#dtt_cid").val(cid);
            $("#dtt_uid").val(uid);
            $("#dtt_jobname").val(jobname);

            var str = "职业:"+jobname;
            $.get("/get_infodeteil", {
                cid: cid,
                uid: uid,
              },
                function(myData , status){
                    pids = new Array();
                    // console.log(myData);
                    $("#dt_askills_list").html("");
                    $("#dt_atr_list1").html("");
                    $("#dt_atr_list2").html("");
                    $("#dt_skills_list").html("");
                    $("#dt_objs_list").html("");
                    $("#background").html("");
                    $("#show_at_list").html("");
                    $("#show_at_list2").html("");

                    for(data of myData){
                        var pid = data[0];
                        var kind = data[2];
                        var nid = data[3];
                        var value = data[5];
                        if(kind==1){

                            if(nid==1){
                                var pname = value;
                                $("#dt_name").html(value);
                                $("#dtt_name").val(value);

                                //添加空手攻击
                                var others_h = {"useskill":"近战攻击","damage":"1d3+0.5db","ifdod":1,"ifreat":1};
                                set_objj("dt_objs_list","dt_obj","dt_s_hand","空手",others_h);

                            }
                            if(nid==75){
                                if(value=="0"){
                                    $("#dt_pic").hide();
                                    $("#dt_name_p").show();
                                    $("#dt_name_p .dt_name_pa").html(pname);
                                }
                                else{
                                    $("#dt_name_p").hide();
                                    $("#dt_pic").show();
                                    $("#dt_pic .dt_pica").attr("src",value);
                                }
                            }
                            if(nid==9)
                                get_winfo(parseInt(value),"background");
                            if(nid==16)
                                str = str+" 年龄:"+value;
                            if(nid==17)
                                str = str+" 性别:"+value;
                            if(nid==18)
                                str = str+" 居住地:"+value;
                            if(nid==19)
                                str = str+" 故乡:"+value;
                            if(nid==48)
                                $("#background").append(value);
                            if(nid==52){
                                $("#dnotebook_v").val(value);
                                noteid = pid;
                            }

                            {% for at in atrr %}
                            // 属性点数下
                                {% if at.0>=20 and at.0<=27 or at.0==31 %}
                                    if(nid=={{at.0}}){
                                        if(nid==20){
                                            liliang = parseInt(value);
                                        }
                                        if(nid==21){
                                            tizhi = parseInt(value);
                                        }
                                        if(nid==22){
                                            tixing = parseInt(value);
                                        }
                                        if(nid==26){
                                            yizhi = parseInt(value);
                                        }
                                        var str2="{{at.2}}";
                                        set_ask("dt_atr_list2","dt_skill","dt_s_"+pid,str2,value,0,0,nid,pid);
                                        pids.push(pid);
                                    }
                                {% endif %}
                            {% endfor %}
                            {% for at in atrr %}
                            // 属性点数上
                                {% if at.0>=29 and at.0<=32 and at.0!=31 %}
                                    if(nid=={{at.0}}){
                                        var str2="{{at.2}}";
                                        if(nid==29){
                                            var tili=parseInt((tizhi+60)/10);
                                            set_ask("dt_atr_list1","dt_skill2","dt_s_"+pid,str2,value,tili,0,nid,pid);
                                        }
                                        else if(nid==30){
                                            var lizhi = yizhi;
                                            set_ask("dt_atr_list1","dt_skill2","dt_s_"+pid,str2,value,lizhi,0,nid,pid);
                                        }
                                        else if(nid==32){
                                            var mofa = parseInt(yizhi/5);
                                            set_ask("dt_atr_list1","dt_skill2","dt_s_"+pid,str2,value,mofa,0,nid,pid);
                                        }
                                        else{
                                            set_ask("dt_atr_list1","dt_skill2","dt_s_"+pid,str2,value,0,0,0,pid);
                                        }

                                        pids.push(pid);
                                    }
                                {% endif %}
                            {% endfor %}


                            // 剩余金钱
                            {% for at in atrr %}
                                {% if at.0==55 %}
                                    if(nid=={{at.0}}){
                                        //加入db
                                        var db=get_db(liliang,tizhi);
                                        set_ask("dt_atr_list1","dt_skill3","dt_s_db","DB",db,0,0,0,pid);
                                        //加入金钱
                                        var str2="{{at.2}}";
                                        set_ask("dt_objs_list","dt_skill4","dt_s_"+pid,str2,value,1,0,0,pid);
                                        pids.push(pid);

                                    }
                                {% endif %}
                            {% endfor %}

                        }
                        else if(kind==3){
                            {% for name in names %}
                            // 技能点数
                                if(nid=="{{name.0}}"){
                                    var str2="{{name.2}}";
                                    if(parseInt(value)>10){
                                        set_ask("dt_skills_list","dt_skill","dt_s_"+pid,str2,value,0,nid,0,pid);
                                        pids.push(pid);
                                    }
                                    // if(nid==125){
                                    //     var attack_txt = "闪避: <small class='text-muted'>"+value+"</small>";
                                    //     var atack_b = $("#tmp_attackb").clone(true);
                                    //     atack_b.attr("id","atta_shan");
                                    //     $("#atta_shan .ttext").html(attack_txt);
                                    // }
                                }
                            {% endfor %}
                        }
                        else if(kind==4){

                            {% for name in names %}
                            // 物品
                                if(nid=="{{name.0}}"){
                                    var damage=0;
                                    var useskill=0;
                                    var skillplu=0;
                                    var skillplu2=0;
                                    var ifdod = 1; //能否闪避
                                    var ifreat = 1;  //能否反击
                                    var str2="{{name.2}}";
                                    {% for in in infoe %}
                                        {% if in.2==8 %}
                                        if(nid=="{{in.1}}"){
                                            damage = "{{in.4}}";
                                        }
                                        {% elif in.2==7 %}
                                        if(nid=="{{in.1}}"){
                                            useskill = "{{in.4}}";
                                        }
                                        {% elif in.2==47 %}
                                        if(nid=="{{in.1}}"){
                                            skillplu = "{{in.4}}";
                                            skillplu2 = "{{in.5}}";
                                        }
                                        {% elif in.2==103 %}
                                        if(nid=="{{in.1}}"){
                                            ifdod = "{{in.4}}";
                                        }
                                        {% elif in.2==104 %}
                                        if(nid=="{{in.1}}"){
                                            ifreat = "{{in.4}}";
                                        }
                                        {% endif %}
                                    {% endfor %}
                                    var others = {"useskill":useskill,"damage":damage,"pid":pid,"nid":nid,"ifdod":ifdod,"ifreat":ifreat}
                                    set_objj("dt_objs_list","dt_obj","dt_s_"+pid,str2,others);

                                }
                            {% endfor %}
                        }
                        else if(kind==9){
                            if(nid==79){
                                var ccid = parseInt(value);
                                get_objc(ccid);
                            }
                        }
                    }
                    $("#dt_odeteil").html(str);


                },"json");
        }

        //修改用户信息的框框
        function set_ask(list,temp,col,name,value,apend=0,nid=0,aid=0,pid=0){
            var cc = $("#"+temp).clone(true);
            cc.attr('id',col);
            cc.attr('style','');
            if(apend==1){
                $("#"+list).prepend(cc);
            }
            else{
                $("#"+list).append(cc);
            }
            if(apend!=0 && apend!=1){
                $("#"+col+" .dt_maxx").html("/"+apend);

            }
            $("#"+col+" .dt_atr_name").html(name);
            $("#"+col+" .dt_atr_value").val(value);

            //骰子 和 参数的nid
            if(nid!=0){
                var listidd = "va_"+nid;
                $("#"+col+" .dt_atr_value").attr("id",listidd);
                $("#"+col+" .dt_mingtou").attr("id","touzi_"+nid);
                $("#"+col+" .dt_atr_value").attr("onchange","change_an("+pid+",'va_"+nid+"')");

            }
            if(aid!=0){
                var listidd = "va2_"+aid;
                $("#"+col+" .dt_atr_value").attr("id",listidd);
                $("#"+col+" .dt_atr_value").attr("onchange","change_an("+pid+",'va2_"+aid+"')");

            }

            $("#"+col+" .dt_mingtou").attr("onclick","tou3('"+listidd+"','"+name+"')");
            $("#"+col+" .dt_mingtoum").attr("onclick","tou3('"+listidd+"','"+name+"',100,'mobile')");
            $("#"+col+" .dt_antou").attr("onclick","tou3('"+listidd+"','"+name+"',100,0,1)");
            $("#"+col+" .dt_antoum").attr("onclick","tou3('"+listidd+"','"+name+"',100,'mobile',1)");



        }

        //修改人物属性
        function change_an(pid,listid) {
            var fromuid = $("#dtt_uid").val();
            var value = $("#"+listid).val();
            socket.emit('update_so', {pid: pid, roomid: "{{group_id}}", token:"{{token}}", v: value, toidp:fromuid,listid:listid});
        }

        //物品信息的框框 (列出物品的列表, 物品条的模板, 物品条的id, 物品名称, 使用技能, 伤害,  物品id, 类型(预设/自定义),描述, 其他)
        function set_objj(list,temp,col,name="0",others="0"){
             // 使用技能, 伤害,  物品id, 类型(预设/自定义),描述,是否可闪避，是否可反击
            var useskill=damage=pid=nid=zhong=kind=desc="0";
            var ifdod=ifreat=1;
            if(others!="0"){
                if(others['useskill']!=undefined)
                    useskill=others['useskill'];
                if(others['damage']!=undefined)
                    damage=others['damage'];
                if(others['pid']!=undefined)
                    pid=others['pid'];
                if(others['nid']!=undefined)
                    nid=others['nid'];
                if(others['zhong']!=undefined)
                    zhong=others['zhong'];
                if(others['kind']!=undefined)
                    kind=others['kind'];
                if(others['desc']!=undefined)
                    desc=others['desc'];
                if(others['ifdod']!=undefined)
                    ifdod=others['ifdod'];
                if(others['ifreat']!=undefined)
                    ifreat=others['ifreat'];
            }

            var cc = $("#"+temp).clone(true);
            var useskillid=0;
            cc.attr('id',col);
            cc.attr('style','');
            $("#"+list).append(cc);
            $("#"+col+" .dt_atr_name").html(name);
            $("#"+col+" .dt_atr_name").attr("title",name);
            //显示伤害,使用技能等等
            $("#"+col+" .dt_atr_sdlist").html("");
            if(useskill=="0" && damage=="0" && desc=="0"){
                var strr='<a class="dropdown-item dt_atr_other">特殊道具</a>';
                $("#"+col+" .dt_atr_sdlist").append(strr);
            }
            if(useskill!="0"){
                if(useskill=="自定义"){
                    var strr='<a class="dropdown-item dt_atr_useskill">命中率:'+zhong+'</a>\n' +
                         '<div class="dropdown-divider"></div>';
                    $("#"+col+" .dt_atr_sdlist").append(strr);
                }
                else{
                    {% for nn in names %}
                    if(useskill=="{{nn.2}}"){
                        useskillid = "{{nn.0}}";
                    }
                    {% endfor %}
                    var strr='<a class="dropdown-item dt_atr_useskill">使用技能:'+useskill+'</a>\n' +
                         '<div class="dropdown-divider"></div>';
                    $("#"+col+" .dt_atr_sdlist").append(strr);
                }

            }
            if(damage!="0"){
                var strr='<a class="dropdown-item dt_atr_damage">伤害:'+damage+'</a>\n' +
                     '<div class="dropdown-divider"></div>';
                $("#"+col+" .dt_atr_sdlist").append(strr);
                $("#"+col+" .dt_atr_name").attr("title","伤害:"+damage);
            }

            if(desc!="0"){
                var strr='<a style="white-space: pre-wrap;\n' +
                    'word-wrap: break-word;\n' +
                    'max-width: 100%;" class="dropdown-item dt_atr_objcd">描述:'+desc+'</a>';
                $("#"+col+" .dt_atr_sdlist").append(strr);
            }
            $("#"+col+" .dt_dt_ifdod").val(ifdod);
            $("#"+col+" .dt_ifreat").val(ifreat);


            $("#"+col+" .dt_mingtou").attr("onclick","tou4("+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"',0,'"+desc+"')");
            $("#"+col+" .dt_mingtoum").attr("onclick","tou4("+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"','mobile','"+desc+"')");

            $("#"+col+" .dt_antou").attr("onclick","tou4("+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"',0,'"+desc+"',1)");
            $("#"+col+" .dt_antoum").attr("onclick","tou4("+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"','mobile','"+desc+"',1)");

            $("#"+col+" .dt_jiaochu").attr("onclick","reng('"+pid+"','"+nid+"','"+kind+"',"+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"',0,'"+desc+"',"+ifdod+","+ifreat+")");
            $("#"+col+" .dt_jiaochum").attr("onclick","reng('"+pid+"','"+nid+"','"+kind+"',"+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"','mobile','"+desc+"',"+ifdod+","+ifreat+")");
            // console.log(pid);
            if(pid!="0"){
                $("#"+col+" .dt_deltou").attr("onclick","delobj("+pid+",'"+kind+"')");
            }
            else{
                $("#"+col+" .dt_deltou").remove();
                $("#"+col+" .dt_jiaochu").remove();
                $("#"+col+" .dt_jiaochum").remove();
            }


            //设置攻击时的按钮
            var attack_txt = name+"<br/>";
            var usk = "";
            var zho = "";
            if(useskill!="0"){
                usk = "<small class='text-muted'>使用技能:"+useskill+" | </small>";
            }
            if(zhong!="0"){
                zho = "<small class='text-muted'>命中率:"+zhong+" | </small>";
            }
            var dam = "<small class='text-muted'>伤害:"+damage+" | </small>";
            attack_txt = attack_txt+usk+zho+dam;

            var atack_b1 = $("#tmp_attackb").clone(true);
            atack_b1.attr("id","atta_1"+col);
            var atack_b2 = $("#tmp_attackb").clone(true);
            atack_b2.attr("id","atta_2"+col);

            var usrid = parseInt($("#dtt_uid").val());

            atack_b1.attr("onclick","tou4f("+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"','"+desc+"',0,"+usrid+",2, "+ifdod+", "+ifreat+")");
            atack_b2.attr("onclick","tou4f("+useskillid+",'"+useskill+"','"+name+"','"+damage+"','"+zhong+"','"+desc+"',0,"+usrid+",2, "+ifdod+", "+ifreat+")");
            $("#show_at_list").append(atack_b1);
            if(ifreat==1){
                $("#show_at_list2").append(atack_b2);
            }
            $("#atta_1"+col+" .ttext").html(attack_txt);
            $("#atta_2"+col+" .ttext").html(attack_txt);

        }

        //设定体力理智魔法
        function tzm(kind,value1,value2){
            var re;
            if(kind=="tili"){
                re = parseInt((value1+value2)/10);
            }
            else if(kind=="lizhi"){
                re = value1;
            }
            else if(kind=="mofa"){
                re = parseInt(value1/5);
            }
            return re;
        }
        //设定伤害加成
        function get_db(value1,value2){
            var cc = value1+value2;
            var db=0;
            if(cc>=2 && cc<=64){
                db="-2";
            }
            else if(cc>=65 && cc<=84){
                db="-1";
            }
            else if(cc>=85 && cc<=124){
                db="0";
            }
            else if(cc>=125 && cc<=164){
                db="1d4";
            }
            else if(cc>=165 && cc<=204){
                db="1d6";
            }
            else{
                db="1d10";
            }
            return db;
        }

        //修改用户信息
        function send_ask() {
            var ccid=$("#dtt_cid").val();
            var uuid=$("#dtt_uid").val();
            var jobbnm=$("#dtt_jobname").val();
            show_deteils(ccid,uuid,jobbnm);
            alert("成功修改");

        }

        //添加调查员笔记
        function send_note() {
            var value = $("#dnotebook_v").val();
                $.post("/updateu", {
                    pid: noteid,
                    gid: "{{group_id}}",
                    token:"{{token}}",
                    v: value
                },
                function(myData , status){
                    // console.log(myData);
                    // alert("成功修改");
                });
        }

        //扔疯狂
        function creacy(){
            if(mycid==0 || mycid=="0" || !mycid){
                alert("请至少将一个卡组加入游戏再投");
                return
            }
            var myname = $("#dtt_myname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('creazy_so', {data: 0, userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic, kind:5, toidp:0, t:0});
        }
        //----------------------------------------------------------------人物卡

        //用户加入游戏
        function add_game(cid,pname) {
            $.post("/addgame", {
                cid: cid,
                gid: "{{group_id}}"
            },
            function(myData , status){
                get_kazu("allkazu","list_players","tp_list_rp","list_pp_");
                $("#wanjialiebiao").click();
                mycid = cid;
                socket.emit('m_join', {userid: "{{myuid}}", roomid:"{{group_id}}"});
            });

        }
        function del_game(cid,uid) {
            $.post("/delgame", {
                cid: cid,
                uid: uid,
                token:"{{token}}",
                gid: "{{group_id}}"
            },
            function(myData , status){
                get_kazu("allkazu","list_players","tp_list_rp","list_pp_");
                $("#wanjialiebiao").click();
                mycid = 0;
                socket.emit('m_join', {userid: "{{myuid}}", roomid:"{{group_id}}"});
            });
        }

        //删除这个房间
        function delet_room(id){
            var r = confirm("是否确认删除房间");
            if (r == true) {
                $.post("/del_room", {
                    id: id,
                },
                function(myData , status){
                    if(myData=="1"){
                        window.location.href="/";
                    }
                    else{
                        alert(myData);
                    }
                });
            } else {
                return;
            }

        }
        function clear_msg(gid) {
            var r = confirm("是否确认清除对话");
            if (r == true) {
                $.post("/del_room_msg", {
                    id: gid,
                },
                function(myData , status){
                    $("#chat-id-1-input").val("");
                    get_msg_lastid(1);
                    // get_msg();
                });
            } else {
                return;
            }
        }


        function randomNum(minNum,maxNum){
            switch(arguments.length){
                case 1:
                    return parseInt(Math.random()*minNum+1,10);
                break;
                case 2:
                    return parseInt(Math.random()*(maxNum-minNum+1)+minNum,10);
                break;
                    default:
                        return 0;
                    break;
            }
        }

        function currentTime(date) {
            var date = new Date(date*1000);//如果date为13位不需要乘1000
            var Y = date.getFullYear() + '-';
            var M = (date.getMonth()+1 < 10 ? '0'+(date.getMonth()+1) : date.getMonth()+1) + '-';
            var D = (date.getDate() < 10 ? '0' + (date.getDate()) : date.getDate()) + ' ';
            var h = (date.getHours() < 10 ? '0' + date.getHours() : date.getHours()) + ':';
            var m = (date.getMinutes() <10 ? '0' + date.getMinutes() : date.getMinutes()) + ':';
            var s = (date.getSeconds() <10 ? '0' + date.getSeconds() : date.getSeconds());
            return Y+M+D+h+m+s;
        }

        function tou2(value=0,obj=0,max=100,type=0,an=0) {
            if(mycid==0 || mycid=="0" || !mycid){
                alert("请至少将一个卡组加入游戏或点开一个人物卡再输入");
                return
            }
            if(an==1){
                //是否暗投
                var kind = 2;
                var toid_p="{{group_creater}}";
            }
            else{
                //是否私信
                var kind = 5;
                var toid_p=0;
            }
            //设置名称
            var pname = $("#dtt_name").val();

            obj2 = pname+obj;
            var myname = $("#dtt_myname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('tou_1', {data: value, userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic,
            kind:kind, toidp:toid_p, t:0, obj : obj2,max : max,type:type});
        }

        //值,头部显示的,是否暗骰,战斗类型(SPD),人/怪物id,怪物还是人(1怪物2人),战斗房间id
        function tou2f(value=0,obj=0,an=0,roll_t=0,pcid=0,pc_t=0,f_id=0) {
            if(mycid==0 || mycid=="0" || !mycid){
                alert("请至少将一个卡组加入游戏或点开一个人物卡再输入");
                return
            }
            if(an==1){
                //是否暗投
                var kind = 2;
                var toid_p="{{group_creater}}";
            }
            else{
                //是否私信
                var kind = 5;
                var toid_p=0;
            }
            //设置名称
            if("{{group_creater}}"=="{{myuid}}"){
                var pname = "";
            }
            else{
                var pname = $("#dtt_name").val();
            }
            //从id来的攻击
            var at_fromid = attack_fromid;
            obj2 = pname+obj;
            var myname = $("#dtt_myname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('tou_1f', {data: value, userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic,
            kind:kind, toidp:toid_p, t:0, obj : obj2,max : 100,type:0, kp:"{{group_creater}}", roll_t:roll_t, pcid:pcid,pc_t:pc_t,f_id:f_id,xiala:1,at_fromid:at_fromid});
            attack_fromid=0;//来自id归零
        }

        function tou3(listid=0,obj=0,max=100,type=0,an=0){
            var value = $("#"+listid).val();
            tou2(value,obj,max,type,an);
        }
        function tou3f(listid=0,obj=0,an=0,roll_t=0,pcid=0,pc_t=0,f_id=0){
            var value = $("#"+listid).val();
            tou2f(value,obj,an,roll_t,pcid,pc_t,f_id);

        }

        //物品骰子+伤害
        function tou4(skillid=0,skillname="0",obj="0",damage="0", zhong="0",type=0, desc="0",an=0){
            if(mycid==0 || mycid=="0" || !mycid){
                alert("请至少将一个卡组加入游戏再输入");
                return
            }
            if(zhong=="0"){
                if(skillid!=0){
                    skillid="va_"+skillid;
                    zhong = $("#"+skillid).val();
                    // $("#"+touziid).click();
                }
            }
            if(an==1){
                var kind = 2;
                var toid_p="{{group_creater}}";
            }
            else{
                var kind = 5;
                var toid_p=0;
            }
            //设置名称
            var pname = $("#dtt_name").val();

            var db=$("#dt_s_db .dt_atr_value").val();

            var myname = $("#dtt_myname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('tou_2', {data: "0", userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic,
                kind:kind, toidp:toid_p, t:0, obj : obj,type:type,pname:pname,skillname:skillname,zhong:zhong,desc:desc, db:db,damage:damage});
        }

        //战斗时 物品骰子+伤害  (使用技能id,技能名称,头部显示,伤害,命中率,描述,暗投, 人/怪物id, 怪物还是人(1怪物2人),ifdod是否可闪避 ifreat是否可反击)
        function tou4f(skillid=0,skillname="0",obj="0",damage="0", zhong="0", desc="0",an=0,pcid=0,pc_t=0,ifdod=1,ifreat=1){
            var f_id = fight_id_g;
            var a_method = attack_method;
            var roll_t="ATA";
            var f_a=1;  //优势/劣势 次数
            var f_type=0;  //1优势 2劣势
            if(a_method==1){
                roll_t="ATA";
            }
            else if(a_method==2){
                roll_t="ATA";
                f_type=1;
                f_a = 2;
            }
            else if(a_method==3){
                roll_t="ATA";
                f_type=2;
                f_a = 2;
            }
            else if(a_method==4){
                roll_t="REA";
                if(ifreat!=1){
                   obj=obj+"试图反击,但是似乎难以击中";
                   zhong = 1;
                }
                else{
                    obj=obj+"反击";
                }
            }
            if(mycid==0 || mycid=="0" || !mycid){
                alert("请至少将一个卡组加入游戏再输入");
                return
            }
            if(zhong=="0"){
                if(skillid!=0){
                    skillid="va_"+skillid;
                    zhong = $("#"+skillid).val();
                    // $("#"+touziid).click();
                }
            }
            if(an==1){
                var kind = 2;
                var toid_p="{{group_creater}}";
            }
            else{
                var kind = 5;
                var toid_p=0;
            }
            //设置名称
            var pname = $("#dtt_name").val();

            var db=$("#dt_s_db .dt_atr_value").val();

            //从id来的攻击
            var at_fromid = attack_fromid;

            var d_plus=1;
            var jobname = $("#dtt_jobname").val();
            if(jobname=="格斗家" && skillname=="空手"){
                d_plus=2;
            }

            var myname = $("#dtt_myname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('tou_2f', {data: "0", userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic,
                kind:kind, toidp:toid_p, t:0, obj : obj,type:0,pname:pname,skillname:skillname,zhong:zhong,desc:desc, db:db,damage:damage,
                kp:"{{group_creater}}", roll_t:roll_t, pcid:pcid,pc_t:pc_t,f_id:f_id,f_a:f_a,f_type:f_type,xiala:1,
                d_plus:d_plus,at_fromid:at_fromid,ifdod:ifdod,ifreat:ifreat});
            $('#attackshow').modal('hide');
            attack_method=1;//攻击方式归零
            attack_fromid=0;//来自id归零
        }

        //属性和技能的联合骰子(最终技能id，属性id，技能id)
        function toul(nnid, sxid, jnid, diffi, an=0) {
            if(mycid==0 || mycid=="0" || !mycid){
                alert("请点击一个人物卡之后再进行检定！");
                return
            }
            var shuxing=$("#va2_"+sxid).val();
            var jineng =$("#va_"+jnid).val();
            if(!jineng){
                jineng=10;
            }
            var ppname = $("#dtt_name").val();
            if(!shuxing){
                alert("请点击一个人物卡之后再进行检定！");
                return
            }
            if(an==1){
                var kind = 2;
                var toid_p="{{group_creater}}";
            }
            else{
                var kind = 5;
                var toid_p=0;
            }
            var myname = $("#dtt_myname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('tou_3', {data: "0", userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic,
                kind:kind, toidp:toid_p, t:0, nnid : nnid,sx:shuxing,jn:jineng,ppname:ppname,diffi:diffi});
        }

        //交出物品
        function reng(pid,nid,kind,skillid=0,skillname="0",obj="0",damage="0", zhong="0",type=0, desc="0", ifdod=1, ifreat=1) {
            if(kind!=0){
                kind=1;
                var ppid = pid;
            }
            else{
                var ppid = nid;
            }
            //设置名称
            var pname = $("#dtt_name").val();

            var ht = pname+'交出了 <a  class="text-muted" onclick=take('+ppid+','+kind+',"'+obj+'"); href="#"><strong>'+obj+'</strong></a>';
            if(skillname!=0){
                ht = ht+"<br />技能使用："+skillname;
            }
            if(zhong!=0){
                ht = ht+"<br />命中："+zhong;
            }
            if(damage!=0){
                ht = ht+"<br />伤害："+damage;
            }
            if(desc!=0){
                ht = ht+"<br />描述："+desc;
            }
            if(ifdod==0){
               ht = ht+"<br />不可被闪避";
            }else {
                ht = ht+"<br />可被闪避";
            }
            if(ifreat==0){
               ht = ht+"<br />不可用于反击";
            }else {
                ht = ht+"<br />可用于反击";
            }
            send_msg(ht);
            if(type=="mobile"){
                $("#chat-1-user-profile").attr("class","chat-sidebar");
            }
        }

        function take(pid,kind,obj){
            var uid = $("#dtt_uid").val();
            var myname = $("#dtt_myname").val();
            var jobbnm=  $("#dtt_jobname").val();
            var mypic = $("#dtt_mypic").val();
            socket.emit('take_so', {data: "0", userid: "myid", roomid: "{{group_id}}",mycid:mycid,myname:myname,mypic:mypic,
                kind:5, toidp:0, t:0, obj : obj,kkind:kind,pid:pid});
            show_deteils(mycid,uid,jobbnm);
        }
        //----------------------------------------------------------------物品相关
        function add_obj() {
            var obj_id = $("#list_objs").val();
            var uid = $("#dtt_uid").val();
            var cid = $("#dtt_cid").val();
            if(obj_id==0){
                alert("选择物品之后才能添加");
            }
            if(obj_id==14){
                alert("自定义物品需要在下面的自定义物品表填写并添加");
            }
            else{
                $.post("/add_obj", {
                    obj_id: obj_id,
                    uid: uid,
                    cid: cid
                },
                function(myData , status){
                    var jobbnm=$("#dtt_jobname").val();
                    show_deteils(cid,uid,jobbnm);
                });
            }
        }

        function delobj(pid=0,kind=0){
            $.post("/delobj", {
                    pid: pid,
                    kind:kind,
                    token:"{{token}}",
                },
                function(myData , status){
                    if(myData=="0"){
                        alert("出现迷之错误,请重新登录游戏");
                        return;
                    }
                    var ccid=$("#dtt_cid").val();
                    var uuid=$("#dtt_uid").val();
                    var jobbnm=$("#dtt_jobname").val();
                    show_deteils(ccid,uuid,jobbnm);
                    // console.log(myData);
                });
        }


        //显示添加自定义物品菜单
        function show_obc() {
            var sele = $('#list_objs').val();
            if(sele==14){
                $('#dt_objs_addc').show();
                window.location.href="#dt_zidingyi";
            }
            else {
                $('#dt_objs_addc').hide();
            }

        }

        //自定义时出现命中率
        function get_ob_val() {
            var sele_skill = $('#list_obskills').val();
            if(sele_skill=="自定义" || sele_skill==0){
                $('#objc_zhong').show();
            }
            else {
                $('#objc_zhong').hide();
            }
        }

        //添加自定义物品
        function add_objc(){
            var name   = $("#objc_name").val();       //名称
            var usek   = $("#list_obskills").val();   //使用技能
            var zhong  = $("#objc_zhong").val();      //命中率
            var damage = $("#objc_damage").val();     //伤害
            var desc   = $("#objc_desc").val();       //特殊描述
            var ifdod  = $("#objc_ifdod").val();       //可否被闪避
            var ifrea  = $("#objc_ifreata").val();     //可否反击
            var uid = $("#dtt_uid").val();
            var cid = $("#dtt_cid").val();
            var jobbnm=  $("#dtt_jobname").val();
            var method = "player";
            if(!name){
                alert("请至少填写物品名称");
                return;
            }
            if(usek==0){
                if(zhong && zhong!=0){
                    usek="自定义";
                }
            }
            $.post("/add_objc", {
                    name: name,
                    method:method,
                    use_skill: usek,
                    zhong: zhong,
                    damage: damage,
                    desc:desc,
                    ifdod:ifdod,
                    ifreata:ifrea,
                    uid:uid,
                    cid:cid
                },
                function(myData , status){
                    if(myData=="1"){
                        $("#objc_name").val("");
                        $("#objc_zhong").val("");
                        $("#objc_damage").val("");
                        $("#objc_desc").val("");
                        alert("成功添加");
                        show_deteils(cid,uid,jobbnm);
                    }
                });
        }
        
        //显示自定义物品
        function get_objc(id) {
            $.get("/get_objc", {
                    id:id
                },
                function(myData , status){
                    var pid = id;

                    var ifdod = 1;
                    var ifreat = 1;
                    for(data of myData){
                        var aid = data[3];
                        var v   = data[4];
                        var v2  = data[5];

                        if(aid=="90"){
                            var name = v;
                        }
                        else if(aid=="86"){
                            var useskill = v;
                            var zhong = v2;
                        }
                        else if(aid=="87"){
                            var damage = v;
                        }
                        else if(aid=="88"){
                            var desc = v;
                        }
                        else if(aid=="103"){
                            ifdod = v; //是否可闪避
                        }
                        else if(aid=="104"){
                            ifreat = v; //是否可反击
                        }
                    }

                    var others = {"useskill":useskill,"damage":damage,"pid":pid,"zhong":zhong,"kind":"custom","desc":desc,"ifdod":ifdod,"ifreat":ifreat}
                    set_objj("dt_objs_list","dt_obj","dt_sc_"+pid,name,others);
                },"json");
        }
        
        
        //----------------------------------------------------------------物品相关

        //----------------------------------------------------------------手机优化
        //手机点击个人信息时出现的
        function show_myde() {
            var mycid = $("#dtt_mycid").val();
            var myuid = $("#dtt_myuid").val();
            var mywork = $("#dtt_myjobname").val();
            //如果加入游戏直接
            if(myuid=="{{group_creater}}" || myuid==0){
                $("#chat-1-info").attr("class","chat-sidebar chat-sidebar-visible");
            }
            else{
                show_deteils(mycid,myuid,mywork);
                $("#chat-1-user-profile").attr("class","chat-sidebar chat-sidebar-visible");
            }

        }

        //手机界面时切回主界面
        function qiehui(){
            $("#chat-1-user-profile").attr("class","chat-sidebar");
            $("#chat-1-info").attr("class","chat-sidebar chat-sidebar-visible");
        }
        //----------------------------------------------------------------手机优化

        if ( document.querySelector('#dropzone-template-js') ) {
            var template = document.querySelector('#dropzone-template-js');
            var template_element = document.querySelector('#dropzone-template-js');
            template_element.parentNode.removeChild(template_element);
        }

        [].forEach.call(document.querySelectorAll('.dropzone-map-js'), function (el) {

            var clickable         = el.querySelector('.dropzone-button-js').id;
            var url               = el.getAttribute('data-dz-url');
            var previewsContainer = el.querySelector('.dropzone-previews-js');

            var myDropzonemap = new Dropzone(el, {
                url: url,
                previewTemplate: template.innerHTML,
                previewsContainer: previewsContainer,
                clickable: '#' + clickable,
                init: function() {

                this.on("success", function(file, responseText) {
                        // 回传信息 可以使用其他方法 只是测试用
                        // console.log(responseText);
                        send_img(responseText);
                    })
                }
            });
        });

        [].forEach.call(document.querySelectorAll('.dropzone-single-image'), function (el) {


            var clickable         = el.querySelector('.dropzone-button-js').id;
            var previewsContainer = el.querySelector('.dropzone-single-image-container');
            var url               = el.getAttribute('data-dz-url');
            var dropzone_avatar = new Dropzone(el, {
                url: url,
                previewTemplate: "<div class=\"avatar avatar mb-5\"><img src=\"#\" class=\"avatar-img\" data-dz-thumbnail=\"\" alt=\"\"></div>",
                previewsContainer: previewsContainer,
                clickable: "#" + clickable,
                maxFiles: 1,
                acceptedFiles: "image/jpeg,image/png,image/gif",

                init: function() {
                    this.on("maxfilesexceeded", function(file) {
                        this.removeAllFiles();
                        this.addFile(file);
                    }),

                    this.on("complete", function(file) {
                        el.querySelector(".dropzone-single-image-prew").style.display = "none";
                    }),

                    this.on("success", function(file, responseText) {
                        // 回传信息 可以使用其他方法 只是测试用
                        // console.log(responseText);
                    });
                }
            });
        });


        function set_imgs(arry, filelisttemplate){
            // var filelistname=["map_1585167062_85784.gif","map_1585173659_74282.gif"];
            //need：通过后台获得 现为测试
            var filelistname=arry;
            var template = filelisttemplate;
            // console.log(template)
            $("#chat-id-2-files .map_list").empty();
            filelistname.forEach(function(val){
                template = $("#file-list-template-0").clone(true);
                template.attr('id','map_'+val[0]);
                $("#chat-id-2-files .map_list").append(template);
                $("#map_"+val[0]+" .map_name").text(val[2]);
                $("#map_"+val[0]+" .map_name").attr("title",val[2]);
                $("#map_"+val[0]+" .map_smallpic").attr("src",val[2]);
                $("#map_"+val[0]+" .map_showu").attr("imgurl",val[2]);
                $("#map_"+val[0]+" .map_showh").attr("onclick","showh_img('"+val[2]+"')");
                $("#map_"+val[0]+" .map_send").attr("onclick","send_msg('img "+val[2]+"')");

                // $("[title ='file-list-template-filename']").text(val)
                // $("[title ='file-list-template-filename']").attr("title",val)
                // $("[imgurl ='file-list-template-imgurl']").attr("imgurl",val)
            });
        }

        // 将图片显示出来
        function showo_img() {
            $.get("/get_showimg", {
                gid: "{{group_id}}"
            },
            function(myData , status){
                if(myData!="0"){
                    $("#map-display-1").find("img").attr("src",myData)
                    // console.log("要显示的图片"+myData);
                }
            });
        }
        // 标记显示图片
        function showh_img(url){
            $.post("/showh_map", {
                url:url,
                token: "{{token}}",
                gid: "{{group_id}}"
            },
            function(myData , status){
                if(myData!="0"){
                    showo_img();
                    // alert("已显示图片");
                    // console.log(myData);
                }
            });
        }

        //上传图片地址
        function send_img(url){
            $.post("/add_map", {
                url:url,
                token: "{{token}}",
                gid: "{{group_id}}"
            },
            function(myData , status){
                if(myData!="1"){
                    console.log(myData);
                }
                show_imgs();
            });
        }

        // 获取图片列表
        function show_imgs(){
            $.post("/show_map", {
                token: "{{token}}",
                gid: "{{group_id}}"
            },
            function(myData , status){
                // console.log(myData);
                if(myData!=0){
                    // var imglist = new Array();
                    // for(data of myData){
                    //     imglist.push(data[2]);
                    // }
                    // console.log(imglist);
                    var filelisttemplate = $("#file-list-template-0").clone(true);
                    var filelistname=myData;

                    set_imgs(filelistname,filelisttemplate);
                }

            });
        }

        // 将图片显示出来
        function showo_img() {
            $.get("/get_showimg", {
                gid: "{{group_id}}"
            },
            function(myData , status){
                if(myData!="0"){
                    $("#map-display-1").find("img").attr("src",myData);
                    $("#map-display-1").attr("href",myData);
                    // console.log("要显示的图片"+myData);
                }
            });
        }


        //上传图片地址
        function del_img(url){
            $.post("/del_map", {
                url:url,
                token: "{{token}}",
                gid: "{{group_id}}"
            },
            function(myData , status){
                if(myData!="1"){
                    console.log(myData);
                }
            });
        }

        $('#chat-id-1-input').keydown(function (e) {
            var keyCode = e.keyCode || e.which;
            if (keyCode == 13) {
                sub_send_msg();
                return false;
            }
        });





        ///----------------------------------------------------------------战斗相关
        //获取结果参数 f_id:战斗房间id type:1怪物/2玩家 iid:怪物/玩家uid roll_t:类型 s_lv:扔骰等级 roll_value:骰子值
        function get_f_info_fun(data) {
            var f_id = parseInt(data['f_id']);
            var type = parseInt(data['pc_t']);
            var iid = parseInt(data['id']);
            var roll_t = data['roll_t'];
            var s_lv = parseInt(data['s_lv']);
            var roll_value = parseInt(data['roll_value']);
            var ifdod = data['ifdod']; //是否可闪避
            var ifreat = data['ifreat']; //是否可反击
            for(ii in mon_fi_now){
                if(mon_fi_now[ii][0]==f_id){
                    var finish_coun=0;
                    for(iii in mon_fi_now[ii][1]){
                        var mtype = mon_fi_now[ii][1][iii]['type'];
                        var mid = mon_fi_now[ii][1][iii]['id'];
                        if(mtype==type && mid==iid){
                            //决定顺序阶段
                            if(roll_t=="SPD"){
                                mon_fi_now[ii][1][iii]['speed']=s_lv;
                                mon_fi_now[ii][1][iii]['spd_v']=roll_value;
                                mon_fi_now[ii][1][iii]['finish']=1;
                            }
                            else if(roll_t=="DOD" || roll_t=="REA"){
                                //de_type 1 闪避 2 反击
                                mon_fi_now[ii][1][iii]['de_lv']=s_lv;
                                //攻击者信息
                                var attack_fromid = parseInt(data['at_fromid']);
                                var attacker_info_iii = fight_get_l(f_id,attack_fromid); //输出是iii
                                var attacker_info =mon_fi_now[ii][1][attacker_info_iii];
                                var attacker_lv = attacker_info['at_lv'];
                                var attacker_av = attacker_info['at_v'];
                                var attacker_type = attacker_info['at_type']; //1是不可闪避，0是可以闪避
                                var attacker_name = attacker_info['name'];
                                var ht="<h5>战况:</h5>";
                                var ht_s="";
                                if(roll_t=="DOD"){
                                    //闪避的情况
                                    mon_fi_now[ii][1][iii]['de_type']=1;
                                    mon_fi_now[ii][1][iii]['de_v']=0;
                                    if(attacker_lv<=6){
                                        //未命中
                                        ht = ht + " /ita " +attacker_name+" 未命中 /ita "+mon_fi_now[ii][1][iii]['name']+" ";
                                    }
                                    else if(attacker_lv>s_lv || attacker_type==1){
                                        //闪避失败
                                        mon_fi_now[ii][1][iii]['hp'] = mon_fi_now[ii][1][iii]['hp'] - attacker_av;
                                        ht = ht +" /ita " +attacker_name+" 击中了 /ita "+mon_fi_now[ii][1][iii]['name']+" 并造成了" +
                                            " <span class=\"text-success font-weight-bold\">"+attacker_av+"</span>点伤害！";
                                        var ht1 = fight_reduhp(ii,iii);
                                        ht = ht +ht1;
                                        ht_s = ht;
                                    }
                                    else {
                                        //闪避成功
                                        ht = ht + " /ita "+mon_fi_now[ii][1][iii]['name']+" 成功闪避了 /ita " +attacker_name+" 的攻击！";
                                    }

                                }
                                else if(roll_t=="REA"){
                                    //反击的情况
                                    mon_fi_now[ii][1][iii]['de_type']=2;
                                    mon_fi_now[ii][1][iii]['de_v']=roll_value;
                                    if(attacker_lv<s_lv && s_lv>6 && attacker_type!=1){
                                        //攻击者被反击击中
                                        attacker_info['hp']=attacker_info['hp'] - roll_value;
                                        ht = ht + " /ita " +attacker_name+" 试图攻击 /ita "+mon_fi_now[ii][1][iii]['name']+" ，但是受到了反击，并损失了" +
                                            "<span class=\"text-success font-weight-bold\">"+roll_value+"</span> 点体力！";
                                        var ht1 = fight_reduhp(ii,attacker_info_iii);
                                        ht = ht +ht1;
                                        ht_s = ht;
                                    }
                                    else if(attacker_lv>6 && (attacker_lv>=s_lv || attacker_type==1)){
                                        //反击失败并被打中
                                        mon_fi_now[ii][1][iii]['hp'] = mon_fi_now[ii][1][iii]['hp'] - attacker_av;
                                        ht = ht + " /ita "+mon_fi_now[ii][1][iii]['name']+" 试图反击, 但是反击失败了,受到 /ita " +attacker_name+" " +
                                            " 的<span class=\"text-success font-weight-bold\">"+attacker_av+"</span>点伤害！";
                                        var ht1 = fight_reduhp(ii,iii);
                                        ht = ht +ht1;
                                        ht_s = ht;
                                    }
                                    else{
                                        //两边打醉拳
                                        ht = ht + " /ita " +attacker_name+" 和 /ita "+mon_fi_now[ii][1][iii]['name']+" 都未命中对方！";
                                    }
                                }
                                send_msg(ht);
                                if(ht_s!=""){
                                    mon_fi_now[ii][5]=mon_fi_now[ii][5]+"<p> </p>"+ht_s;
                                }
                                cs("战况总结：");
                                cs(mon_fi_now);
                                fight_continue(f_id);
                                break;
                            }
                            else if(roll_t=="ATA"){ //攻击
                                mon_fi_now[ii][1][iii]['at_lv']=s_lv;
                                mon_fi_now[ii][1][iii]['at_v']=roll_value;
                                if(ifdod==0){
                                    mon_fi_now[ii][1][iii]['at_type']=1;
                                }
                                else {
                                    mon_fi_now[ii][1][iii]['at_type']=0;
                                }
                                mon_fi_now[ii][1][iii]['finish']=1;
                                var mpname = mon_fi_now[ii][1][iii]['name'];
                                if(mtype==1){//怪物
                                    if(mon_fi_now[ii][1][iii]['status']==1){
                                        var target_id = mon_fi_now[ii][1][iii]['at_target'];
                                        if(target_id ==0){
                                            var target = mon_set_target(f_id);
                                        }
                                        else {
                                            var target = get_more_fromuid(f_id,target_id);
                                        }
                                    }
                                    else{
                                        var target = mon_set_target(f_id);
                                    }
                                    var targetid = target['id'];
                                    var targetname = target['name'];
                                    var ply_hp = target['hp'];
                                    var ply_status = target['status'];
                                    fight_d_player_give(f_id,targetid,targetname,iid,mpname,ply_hp,ply_status);
                                }
                                else if(mtype==2){//玩家
                                    var target = ply_set_target(f_id)
                                    var targetid = target['id'];
                                    var targetname = target['name'];
                                    fight_d_mon(f_id,targetid,targetname,iid,mpname);
                                }
                                else {
                                    cs("异常提示：mtype:"+mtype);
                                    return;
                                }
                                break;
                            }
                            else if(roll_t=="ESC"){ //撤离战斗
                                mon_fi_now[ii][1].splice(iii,1);
                                var iil = fight_get_l(f_id,iid ,3);
                                mon_fi_now[ii][3].splice(iil,1);
                                fight_continue(f_id);
                                break;
                            }
                        }
                        var iffinish = mon_fi_now[ii][1][iii]['finish'];
                        finish_coun = finish_coun+iffinish;

                    }
                    mon_fi_now[ii][1].sort(pcompare("speed",false));
                    console.log(mon_fi_now[ii]);
                    break;
                }
            }
        }
        //根据战斗房间id找到那一条数据
        function fight_getallinfo(fightid) {
           for(ii in mon_fi_now) {
               if (mon_fi_now[ii][0] == fightid) {
                   return mon_fi_now[ii];
               }
           }
        }
        // 加入战斗
        function fight_join(fightid){
            var myname = $("#dtt_myname").val();
            close_b(".button_join");
            var ht = myname+" 加入了战斗";
            var hp = $("#va2_29").val();
            var con = $("#va2_26").val(); //体质
            var wil = $("#va2_21").val(); //意志
            var spd = $("#va2_23").val(); //敏捷

            socket.emit('fight_join', {userid: "{{myuid}}", roomid:"{{group_id}}", pname:myname, hp:hp, con:con, wil:wil, spd:spd, fightid:fightid});
            send_msg(ht,0,0,1);
            open_b(".button_join");
        }
        //战斗开始
        function fight_begin(fightid){
            for(ii in mon_fi_now){
                if(mon_fi_now[ii][0]==fightid){
                    var a = mon_fi_now[ii][2];
                    var b = mon_fi_now[ii][3];
                    mon_fi_now[ii][1] = a.concat(b);
                    for(iii in mon_fi_now[ii][1]){
                        var iid = mon_fi_now[ii][1][iii]['id'];
                        var type = mon_fi_now[ii][1][iii]['type'];
                        var mname = mon_fi_now[ii][1][iii]['name'];
                        if(type==1){
                            //敏捷值
                            tou_mon_f(iid,"SPD",mname,type,fightid);
                        }
                        else if(type==2){
                            socket.emit('reng_pi', {toidp: iid, roomid:"{{group_id}}", roll_t:"SPD",pc_t:type,f_id:fightid});
                        }
                    }
                    break;
                }
            }
        }
        //真~战斗开始
        function fight_begin2(fightid){
            close_b(".button_begin");
            for(ii in mon_fi_now){
                if(mon_fi_now[ii][0]==fightid){
                    if(mon_fi_now[ii][4]!=0){
                        alert("战斗已经开始");
                        return;
                    }
                    mon_fi_now[ii][4]=1; //开始标记
                    //合并怪物和人，然后排序
                    var a = mon_fi_now[ii][2];
                    var b = mon_fi_now[ii][3];
                    if(b.length == 0){
                        alert("没有玩家加入，无法开始战斗！");
                        $(".button_begin").attr("disabled",false);
                        return;
                    }
                    mon_fi_now[ii][1] = a.concat(b);
                    mon_fi_now[ii][1].sort(pcompare("speed",false));
                    //决定顺序阶段
                    // var ht="<h5>战斗行动:</h5><p><small class=\"text-muted\">请在一轮战斗中分别扔一个战斗骰和一个闪避或反击骰,系统将自动结算</small></p><span>/attackb "+f_id+"</span>"
                    // send_msg(ht);
                    var ht1 = "行动顺序为:<br />";
                    for(iii in mon_fi_now[ii][1]){
                        mon_fi_now[ii][1][iii]['finish']=0;
                        var name = mon_fi_now[ii][1][iii]['name'];
                        var spd_v = mon_fi_now[ii][1][iii]['spd_v'];
                        var spd_lv = mon_fi_now[ii][1][iii]['speed'];
                        var spd_lvt = set_secces_txt(spd_lv);
                        ht1=ht1+name+"<small class='text-muted'>("+spd_lvt+spd_v+")</small> -> ";
                    }
                    ht1 = ht1+"结束";
                    ht2 = ht1+" /queren "+fightid;
                    send_msg(ht2);
                    mon_fi_now[ii][5]=ht1+"<br />"; //最终输出文字
                }
            }
            open_b(".button_begin");
        }
        //在大家看到战斗顺序之后确认开始
        function fight_begin3(fightid,listid=0){
            close_b(".button_fbg");
            for(ii in mon_fi_now) {
                if (mon_fi_now[ii][0] == fightid) {
                    //人还是怪
                    var p_m_type = mon_fi_now[ii][1][listid]['type'];
                    var iid = mon_fi_now[ii][1][listid]['id'];
                    var name = mon_fi_now[ii][1][listid]['name'];
                    var status = mon_fi_now[ii][1][listid]['status'];
                    if(p_m_type==1){
                        //怪物status=0是自动托管，1是手动
                        if(status==1){
                            fight_kp_mon_give(fightid,iid,name);
                        }
                        else{
                            fight_a_mon(fightid,iid,name);
                        }
                    }
                    else if(p_m_type==2){
                        var hp = mon_fi_now[ii][1][listid]['hp'];
                        fight_a_player_give(fightid,iid,name,hp,status);
                    }
                }
            }
            open_b(".button_fbg");
        }
        //战斗继续
        function fight_continue(fightid) {
             for(ii in mon_fi_now) {
                 if (mon_fi_now[ii][0] == fightid) {
                     //结束战斗的情况
                     if(mon_fi_now[ii][2].length==0 || mon_fi_now[ii][3]==0){
                         if(mon_fi_now[ii][2].length==0) {
                             var ht = "<h5>所有参加战斗的敌人都被消灭光了！</h5>";
                         }
                         else if(mon_fi_now[ii][3].length==0){
                             var ht = "<h5>所有参加战斗的玩家都被消灭光了！</h5>";
                         }
                         send_msg(ht);
                         fight_end(fightid);
                         return;
                     }
                     for(iii in mon_fi_now[ii][1]){
                         var finish = mon_fi_now[ii][1][iii]['finish'];
                         if(finish==0){
                             fight_begin3(fightid,iii);
                             return;
                         }
                     }
                     //一个轮回结束以后把finish清零,然后重新开始
                     for(iil in mon_fi_now[ii][1]){
                         mon_fi_now[ii][1][iil]['finish']=0;
                     }
                     fight_continue(fightid);
                     return;
                 }
             }

        }
        //kp决定怪物战斗目标
        function fight_kp_mon_give(fightid,iid,name) {
            var ht = "请kp决定 "+name+" 的目标！ /mfocus "+fightid+" 0 自动目标 0 "+iid+" "+name;
            var mf_list = fight_getallinfo(fightid);
            for(il in mf_list[3]){
                ht = ht + " /mfocus "+fightid+" "+mf_list[3][il]['id']+" "+mf_list[3][il]['name']+" "+mf_list[3][il]['hp']+" "+iid+" "+name;
            }
            send_msg(ht, 2, "kp");
        }
        //对目标uid做标记，并扔出战斗骰子
        function fight_kp_mon_t(fightid,uid,mid,mname) {
            var mf_list = fight_getallinfo(fightid);
            for(il in mf_list[3]){
                if(mf_list[3][il]['id'] == mid){
                    mf_list[3][il]['at_target']=uid;
                    break;
                }
            }
            tou_mon_attack(mid,fightid,mname,"attack");
        }
        //kp决定给玩家的骰子
        function fight_kp_player_give(fightid,iid,name,hp,status) {
            var ht = "请kp决定给 "+name+" 的骰子！"

        }
        //怪物的战斗选项
        function fight_a_mon(fightid,iid,name) {
            tou_mon_attack(iid,fightid,name,"attack");
        }
        //怪物的防御选项
        function fight_d_mon(fightid,iid,name,fromid,fromname) {
            attack_fromid = fromid;
            tou_mon_attack(iid,fightid,name,"defence");
        }
        //给玩家发送战斗选项(战斗房间，用户的id，用户名称)
        function fight_a_player_give(fightid,uid,name,p_hp,p_status) {
            var ht1 = name+"进行战斗";
            send_msg(ht1);
            var ht2="<h5>战斗行动:</h5><p><small class=\"text-muted\">请投一个攻击方式，攻击目标一般是按照敌人的战斗顺序排列，先攻击速度最快的敌人，然后依次攻击其他敌人。</small></p>";
            var ht_a = "";
            var ht_b = "<span>/attackb "+fightid+"</span>";
            if(p_hp<=0){
                p_hp=1;
            }
            if(p_hp<=4){
                ht_a = "<h4 class=\"text-danger\">您的体力仅剩"+p_hp+"，请小心行动！</h4>";
            }
            if(p_status==2){
                ht_a = "<h4 class=\"text-danger\">您已受到重伤，并且体力仅剩"+p_hp+"，请小心行动！</h4>";
            }
            ht2=ht2+ht_a+ht_b;
            send_msg(ht2, 2, uid);
        }
        //给玩家发送防御选项(战斗房间，用户的id，用户名称)
        function fight_d_player_give(fightid,uid,name,fromid,fromname,p_hp,p_status) {
            var ht1 = name+" 受到 "+fromname+" 的攻击！";
            send_msg(ht1);
            var ht2="<h5>防御行动:</h5><p><small class=\"text-muted\">防御行动时证明您已经受到了攻击，可以选择闪避或者反击，" +
                "闪避时若成功等级与敌方相同或更高则成功，而反击时必须高于敌方成功等级。</small></p>";
            var ht_a = "";
            var ht_b = "<span>/defenceb "+fightid+" "+fromid+"</span>";
            if(p_hp<=0){
                p_hp=1;
            }
            if(p_hp<=4){
                ht_a = "<h4 class=\"text-danger\">您的体力仅剩"+p_hp+"，请小心行动！</h4>";
            }
            if(p_status==2){
                ht_a = "<h4 class=\"text-danger\">您已受到重伤，并且体力仅剩"+p_hp+"，请小心行动！</h4>";
            }
            ht2=ht2+ht_a+ht_b;
            send_msg(ht2, 2, uid);
        }
        //玩家/怪物扣血 (给出人和怪血扣到0以下的情况)
        function fight_reduhp(ii,iii) {
            var fightid = mon_fi_now[ii][0];
            var list_info = mon_fi_now[ii][1][iii];
            var s_id = list_info['id'];
            var type = list_info['type'];
            var s_hp = list_info['hp'];
            var name = list_info['name'];
            var ht="";
            //晕厥鉴定
            if(type==2 && s_hp<3 && list_info['status']!=4 && list_info['status']!=2){
                var wil_r = randomNum(1,100);
                var p_wil = list_info['wil'];
                if(wil_r>p_wil){
                    ht = " /ita "+name+" 受伤过重失去意识 <small class='text-muted'>(意志"+wil_r+"/"+p_wil+")</small> ，退出了战斗！";
                    socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: s_hp, toidp:s_id,listid:"va2_29"});
                    mon_fi_now[ii][1].splice(iii,1);
                    var iil = fight_get_l(fightid,s_id ,3);
                    mon_fi_now[ii][3].splice(iil,1);

                    return ht;
                }
                else {
                    ht = " /ita "+name+" 受了严重的伤，但是随即从晕厥中清醒 <small class='text-muted'>(意志"+wil_r+"/"+p_wil+")";
                    list_info['status'] = 4;
                }
            }
            if(s_hp<=0){
                if(type==1){
                //怪物
                    s_hp=0;
                    mon_change_v(s_id,"mon_hp",s_hp);
                    mon_fi_now[ii][1].splice(iii,1);
                    var iil = fight_get_l(fightid,s_id ,2);
                    mon_fi_now[ii][2].splice(iil,1);
                    ht=" /ita "+name+" 失去战斗能力，退出了战斗！";
                }
                else if(type==2){
                //人濒死
                    var p_con = list_info['con'];
                    var p_status = list_info['status'];
                    if(p_status!=2){
                        //晕厥,濒死的情况
                        s_hp=0;
                        var con_r =randomNum(1,100);
                        if(con_r>p_con){
                            //体质没有通过
                            ht="/ita "+name+" 受伤过重死亡！ <small class='text-muted'>(体质"+con_r+"/"+p_con+")";
                            mon_fi_now[ii][1].splice(iii,1);
                            var iil = fight_get_l(fightid,s_id ,3);
                            mon_fi_now[ii][3].splice(iil,1);
                            socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: s_hp, toidp:s_id,listid:"va2_29"});
                        }
                        else {
                            //体质通过
                            s_hp=1;
                            list_info['status'] = 2;
                            ht="/ita "+name+" 受伤严重，但是通过强壮的体质坚持了下来。 <small class='text-muted'>(体质"+con_r+"/"+p_con+")";
                        }
                        socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: s_hp, toidp:s_id,listid:"va2_29"});
                    }
                    else {
                        ht="/ita "+name+" 受伤过重死亡！(已有旧伤)";
                        mon_fi_now[ii][1].splice(iii,1);
                        var iil = fight_get_l(fightid,s_id ,3);
                        mon_fi_now[ii][3].splice(iil,1);
                        socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: s_hp, toidp:s_id,listid:"va2_29"});
                    }
                }
            }
            else {
                if(type==1){
                    mon_change_v(s_id,"mon_hp",s_hp);
                }
                else if(type==2){
                    socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: s_hp, toidp:s_id,listid:"va2_29"});
                }
            }
            ht = "<span class=\"text-danger\">"+ht+"</span>";
            return ht;

        }
        //根据id获取玩家/怪物信息
        function fight_get_l(fightid,iid,w_list=1) {
            for(il in mon_fi_now) {
                if (mon_fi_now[il][0] == fightid) {
                    for(iil in mon_fi_now[il][w_list]) {
                        if(mon_fi_now[il][w_list][iil]['id']==iid){
                            return iil;
                        }
                    }
                }
            }
        }
        //玩家设定目标
        function ply_set_target(f_id) {
            for(ii in mon_fi_now){
                if (mon_fi_now[ii][0] == f_id) {
                    var p = mon_fi_now[ii][2][0];
                    return p;
                }
            }
        }
        //战斗结算
        function fight_sub(ii,show_msg=0) {
            if(show_msg==0){
                show_msg="<h5>本轮战斗结算:</h5>";
            }
            for(iii in mon_fi_now[ii][1]){
                if(mon_fi_now[ii][1][iii]['finish']==0){
                    continue;
                }
                var midi = mon_fi_now[ii][1][iii]['id'];
                var namei = mon_fi_now[ii][1][iii]['name'];
                var typei = mon_fi_now[ii][1][iii]['type']; //怪物还是人
                var statusi = mon_fi_now[ii][1][iii]['status'];
                var hpi = mon_fi_now[ii][1][iii]['hp'];
                var armoi = mon_fi_now[ii][1][iii]['armo'];

                var at_lvi = mon_fi_now[ii][1][iii]['at_lv']; //杀伤等级
                var at_v = mon_fi_now[ii][1][iii]['at_v']; //杀伤值
                mon_fi_now[ii][1][iii]['finish'] = 0;
                if(typei==1){
                    //怪物行动轮
                    //怪物行动 1 先确定打的人
                    var players_n = mon_fi_now[ii][3].length;
                    var plys_r = randomNum(1,players_n);
                    plys_r = plys_r-1;
                    var ply_b = mon_fi_now[ii][3][plys_r]; //选定的人
                    if(at_lvi<=6){
                        //6以下就未命中
                        show_msg = show_msg+namei+" 对 "+ply_b['name']+" 发动攻击,但是未命中目标!";
                        show_msg = show_msg+"<br />";
                        continue;
                    }
                    else{
                        //命中的情况
                        if(ply_b['de_type']==1){
                            //玩家选择闪避
                            if(at_lvi>ply_b['de_lv']){
                                ply_b['hp'] = ply_b['hp']-at_v;
                                show_msg = show_msg+namei+" 对 "+ply_b['name']+" 造成"+at_v+"点伤害";
                            }
                            else{
                                show_msg = show_msg+ply_b['name']+" 闪避了 "+namei+" 的攻击";
                            }
                        }
                        else{
                            //玩家选择反击
                            if(at_lvi<ply_b['de_lv']){
                                if(armoi>0){
                                    //有盔甲
                                    mon_fi_now[ii][1][iii]['armo'] = armoi - ply_b['de_v'];
                                    show_msg = show_msg+ply_b['name']+" 对 "+namei+" 进行反击并造成"+ply_b['de_v']+"点伤害! ";
                                    if(mon_fi_now[ii][1][iii]['armo']<=0){
                                        show_msg = show_msg+" 使其盔甲碎裂!";
                                    }
                                }
                                else{
                                    //没有盔甲
                                    mon_fi_now[ii][1][iii]['hp'] = hpi - ply_b['de_v'];
                                    show_msg = show_msg+ply_b['name']+" 对 "+namei+" 进行反击并造成"+ply_b['de_v']+"点伤害! ";
                                }
                                if(mon_fi_now[ii][1][iii]['hp']<=0){
                                    //被打死
                                    show_msg = show_msg+namei+"失去战斗能力!";
                                    mon_fi_now[ii][1].splice(iii,1);
                                    return fight_sub(ii,show_msg);
                                }
                            }
                            else{
                                ply_b['hp'] = ply_b['hp']-at_v;
                                show_msg = show_msg+ply_b['name']+" 反击失败, "+namei+" 对 "+ply_b['name']+" 造成"+at_v+"点伤害";
                            }
                        }
                        //判定玩家是否重伤
                        if(ply_b['hp']<3){
                            //如果伤害太重
                            if(ply_b['hp']<=0){
                                if(ply_b['status']==2){
                                    //如果重伤则直接死亡
                                    ply_b['hp'] = 0;
                                    ply_b['status'] = 10;
                                    show_msg = show_msg+"<br />"+ply_b['name']+" 已濒死!所以直接死亡!(剩余hp:"+ply_b['hp']+")";
                                }
                                else{
                                    var rcon = randomNum(1,100);
                                    if(rcon>ply_b['con']){
                                        //体质检定失败
                                        ply_b['hp'] = 0;
                                        ply_b['status'] = 10;
                                        show_msg = show_msg+"<br />"+ply_b['name']+" 死亡!(体质:"+rcon+"/"+ply_b['con']+"; 剩余hp:"+ply_b['hp']+")";
                                    }
                                    else {
                                        //体质检定成功
                                        ply_b['hp'] = 1;
                                        var rwil = randomNum(1,100);
                                        if(rwil>ply_b['wil']){
                                            ply_b['status'] = 3; //重伤且晕厥
                                            show_msg = show_msg+"<br />"+ply_b['name']+" 濒死且晕厥(体质:"+rcon+"/"+ply_b['con']+"; 意志:"+rwil+"/"+ply_b['wil']+"; 剩余hp:"+ply_b['hp']+")";
                                        }
                                        else{
                                            ply_b['status'] = 2; //重伤
                                            show_msg = show_msg+"<br />"+ply_b['name']+" 濒死,并从晕厥中苏醒! (体质:"+rcon+"/"+ply_b['con']+"; 意志:"+rwil+"/"+ply_b['wil']+"; 剩余hp:"+ply_b['hp']+")";
                                        }
                                    }
                                }
                            }
                            else{
                                if(ply_b['status'] != 2 && ply_b['status'] != 4){
                                    //仅晕厥
                                    var rwil = randomNum(1,100);
                                    if(rwil>ply_b['wil']){
                                        ply_b['status'] = 1; //晕厥
                                        show_msg = show_msg+"<br />"+ply_b['name']+" 晕厥!(意志:"+rwil+"/"+ply_b['wil']+"; 剩余hp:"+ply_b['hp']+")";
                                    }
                                    else{
                                        ply_b['status'] = 4; //晕厥后恢复
                                        show_msg = show_msg+"<br />"+ply_b['name']+" 从晕厥中恢复理智!(意志:"+rwil+"/"+ply_b['wil']+"; 剩余hp:"+ply_b['hp']+")";
                                    }
                                }

                            }
                            //如果晕厥或者死亡退出战斗
                            if(ply_b['status']==1 || ply_b['status']==3 || ply_b['status']==10){
                                var c_hp = ply_b['hp'];
                                var c_id = ply_b['id'];
                                show_msg = show_msg+"<br />"+ply_b['name']+" 已退出战斗!";
                                socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: c_hp, toidp:c_id,listid:"va2_29"});
                                mon_fi_now[ii][3].splice(plys_r,1);
                                return fight_sub(ii,show_msg);
                            }
                        }
                    }
                    // de_type 1 闪避 2 反击
                }
                else {
                    // 玩家行动轮
                    var mon_b = mon_fi_now[ii][2][0]; //打头的怪物
                    if(at_lvi<=6){
                        //6以下就未命中
                        show_msg = show_msg+namei+" 对 "+mon_b['name']+" 发动攻击,但是未命中目标!";
                        show_msg = show_msg+"<br />";
                        continue;
                    }
                    else{
                        //命中的情况
                        if(mon_b['de_type']==1){
                            //怪物选择闪避
                            if(at_lvi>mon_b['de_lv']){
                                mon_b['hp'] = mon_b['hp']-at_v;
                                show_msg = show_msg+namei+" 对 "+mon_b['name']+" 造成"+at_v+"点伤害";
                            }
                            else{
                                show_msg = show_msg+mon_b['name']+" 闪避了 "+namei+" 的攻击";
                            }
                        }
                        else{
                            //怪物选择反击
                            if(at_lvi<mon_b['de_lv']){
                                if(armoi>0){
                                    //有盔甲
                                    mon_fi_now[ii][1][iii]['armo'] = armoi - mon_b['de_v'];
                                    show_msg = show_msg+mon_b['name']+" 对 "+namei+" 进行反击并造成"+mon_b['de_v']+"点伤害! ";
                                    if(mon_fi_now[ii][1][iii]['armo']<=0){
                                        show_msg = show_msg+" 使其盔甲碎裂!";
                                    }
                                }
                                else{
                                    //没有盔甲
                                    mon_fi_now[ii][1][iii]['hp'] = hpi - mon_b['de_v'];
                                    show_msg = show_msg+mon_b['name']+" 对 "+namei+" 进行反击并造成"+mon_b['de_v']+"点伤害! ";
                                }
                                if(mon_fi_now[ii][1][iii]['hp']<=0){
                                    //被打死
                                    show_msg = show_msg+namei+"失去战斗能力!";
                                    var c_hp = mon_fi_now[ii][1][iii]['hp'];
                                    var c_id = mon_fi_now[ii][1][iii]['id'];
                                    socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: c_hp, toidp:c_id,listid:"va2_29"});
                                    mon_fi_now[ii][1].splice(iii,1);
                                    return fight_sub(ii,show_msg);
                                }
                            }
                            else{
                                mon_b['hp'] = mon_b['hp']-at_v;
                                show_msg = show_msg+" "+namei+" 对 "+mon_b['name']+" 造成"+at_v+"点伤害("+mon_b['name']+" 反击失败)";
                            }
                        }
                    }
                    if(mon_b['hp']<=0){
                        show_msg = show_msg+"<br />"+mon_b['name']+" 失去战斗能力!";
                        var c_hp = mon_fi_now[ii][1][iii]['hp'];
                        var c_id = mon_fi_now[ii][1][iii]['id'];
                        socket.emit('update_so_one', {roomid: "{{group_id}}", token:"{{token}}", v: c_hp, toidp:c_id,listid:"va2_29"});
                        mon_fi_now[ii][2].splice(0,1);
                        return fight_sub(ii,show_msg);

                    }
                }
                show_msg = show_msg+"<br />";
            }
            console.log(mon_fi_now[ii]);
            return show_msg;
        }
        //怪物选择玩家
        function get_at_player(list) {
            for(ii in list){

            }
            var players_n = list.length;

        }
        //攻击阶段 attack_method = 1普通攻击 2优势攻击 3劣势攻击
        function fight_attack(f_id, method){
            fight_id_g = f_id;
            attack_method = method;
            $('#show_at_list2').hide();
            $('#show_at_list').show();
            $('#attackshow').modal('show');
        }
        //防御阶段 attack_method = 4反击
        function fight_defence(f_id, method, fromid) {
            attack_fromid = fromid;
            if(method==2){
                fight_id_g = f_id;
                attack_method = 4;
                //反击
                $('#show_at_list').hide();
                $('#show_at_list2').show();
                $('#attackshow').modal('show');
            }
            else if(method==1){
                //闪避
                var uid = $('#dtt_uid').val();
                tou3f('va_125','闪避',0,"DOD",parseInt(uid),2,f_id);
            }

        }
        //逃跑阶段
        function fight_escape(f_id) {
            var uid = $('#dtt_uid').val();
            var name = $('#dtt_name').val();

            var ht = "撤离战斗!";
            tou3f('va_125',ht,0,"ESC",parseInt(uid),2,f_id);
        }
        //战斗结束
        function fight_end(f_id) {
            for(ii in mon_fi_now){
                if(mon_fi_now[ii][0]==f_id){
                    var ht="<h5>战斗结束!</h5>"
                    send_msg(ht);
                    var txt = "<h5>战斗总结：</h5>"+mon_fi_now[ii][5];
                    send_msg(txt);
                    mon_fi_now.splice(ii,1);

                }
            }

        }
        //重启本轮
        function fight_re_lun(f_id){
            for(ii in mon_fi_now){
                if(mon_fi_now[ii][0]==f_id){
                    for(iii in mon_fi_now[ii][1]){
                        mon_fi_now[ii][1][iii]['finish']=0;
                    }
                    var ht="<h5>本轮战斗重启!</h5><span>/attackb "+f_id+"</span>";
                    send_msg(ht);
                }
            }

        }

        //根据某个值排序 rev=false降序
        function pcompare(prop,rev) {
            // 第二个参数没有传递，默认升序排序
            if(rev === undefined) {
                rev = 1;
            }else {
                rev = rev ? 1: -1;
            }
            return function(obj1,obj2) {
                // 方括号也是访问对象属性的一种方式，优点是可以通过变量访问。
                // 常规写法是 var val1 = obj1.prop;var val2 = obj2.prop;,但是这种不支持变量写法，所有这里不适用
                var val1 = obj1[prop],
                    val2 = obj2[prop];

                // 若是升序排序，此时rev=1,rev*-1=-1,等价于return val1 < val2 ? -1 : 1,，即val1<val2时，val1放在val2前面，否则放后面
                // 若是降序排序，下面句子等价于return val1 < val2 ? 1 : -1，即val1<val2时，val1放在val2后面，否则放在val2前面
                return val1 < val2 ? rev*(-1) : rev*1;
            }
        }
        </script>
    </body>
</html>